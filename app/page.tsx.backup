"use client"

import { useState, useRef, useEffect } from "react"
import { Button } from "@/components/ui/button"
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
import { Input } from "@/components/ui/input"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { Textarea } from "@/components/ui/textarea"
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog"
import { Trophy, ShoppingBag, Medal, Star, Coins, Menu, X, Plus, Save, Users, Target, Crown, Trash2, LogOut, Calendar, Settings, Edit } from "lucide-react"
import { useTorneio } from "@/hooks/use-torneio"
import { Dupla } from "@/types/torneio"
import { toast } from "sonner"
import { LoginPage } from "@/components/auth/login-page"
import { BannerDupla } from "@/components/tournament/banner-dupla"
import { LojaManager } from "@/components/loja/loja-manager"
import { LojaView } from "@/components/loja/loja-view"

export default function App() {
  const [userType, setUserType] = useState<"professor" | "aluno" | null>(null)

  const handleLogin = (type: "professor" | "aluno") => {
    setUserType(type)
  }

  const handleLogout = () => {
    setUserType(null)
  }

  if (!userType) {
    return <LoginPage onLogin={handleLogin} />
  }

  if (userType === "professor") {
    return <ProfessorDashboard onLogout={handleLogout} />
  } else {
    return <AlunoDashboard onLogout={handleLogout} />
  }
}

function ProfessorDashboard({ onLogout }: { onLogout: () => void }) {
  const [activeTab, setActiveTab] = useState("gerenciar")
  const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false)
  const torneio = useTorneio()

  if (torneio.loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-cyan-200 via-blue-200 to-cyan-300 flex items-center justify-center">
        <Card className="p-8">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p className="text-lg font-semibold">Carregando dados do torneio...</p>
          </div>
        </Card>
      </div>
    )
  }

  const tabs = [
    { id: "gerenciar", label: "Gerenciar", icon: Target },
    { id: "duplas", label: "Duplas", icon: Users },
    { id: "rodadas", label: "Rodadas", icon: Calendar },
    { id: "bonus", label: "B√¥nus", icon: Star },
    { id: "rankings", label: "Rankings", icon: Trophy },
    { id: "loja", label: "Loja", icon: ShoppingBag },
  ]

  return (
    <div className="min-h-screen bg-gradient-to-br from-cyan-200 via-blue-200 to-cyan-300 overflow-x-hidden">
      {/* Header */}
      <header className="bg-white shadow-lg border-b-4 border-blue-400">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center py-3 sm:py-4">
            <div className="flex items-center space-x-3 sm:space-x-4">
              <div className="w-10 h-10 sm:w-12 sm:h-12 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl sm:rounded-2xl flex items-center justify-center">
                <Crown className="w-5 h-5 sm:w-6 sm:h-6 text-white" />
              </div>
              <div>
                <h1 className="text-lg sm:text-2xl font-black text-gray-800">Torneio Escolar</h1>
                <p className="text-xs sm:text-sm text-gray-600 font-semibold">Painel do Professor</p>
              </div>
            </div>

            {/* Bot√µes de navega√ß√£o e mobile menu */}
            <div className="flex items-center space-x-2">
              <button
                className="sm:hidden p-2 rounded-lg bg-gray-100"
                onClick={() => setIsMobileMenuOpen(!isMobileMenuOpen)}
              >
                {isMobileMenuOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
              </button>
            </div>

            {/* Desktop navigation */}
            <nav className="hidden sm:flex space-x-1">
              {tabs.map((tab) => {
                const Icon = tab.icon
                return (
                  <button
                    key={tab.id}
                    onClick={() => setActiveTab(tab.id)}
                    className={`px-4 py-2 rounded-xl font-bold text-sm flex items-center space-x-2 transition-all ${activeTab === tab.id
                      ? "bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg"
                      : "text-gray-600 hover:bg-gray-100"
                      }`}
                  >
                    <Icon className="w-4 h-4" />
                    <span>{tab.label}</span>
                  </button>
                )
              })}

              <Button
                onClick={onLogout}
                className="hidden sm:flex items-center space-x-2 text-white px-4 py-2 rounded-xl font-bold text-sm"
                style={{ backgroundColor: "#AEE1F9" }}
              >
                <LogOut className="w-4 h-4" />
                <span>Sair</span>
              </Button>
            </nav>
          </div>

          {/* Mobile navigation */}
          {isMobileMenuOpen && (
            <div className="sm:hidden py-4 border-t">
              <div className="overflow-x-auto custom-scrollbar">
                <nav className="flex gap-2 pb-2 min-w-max scroll-smooth-x">
                  {tabs.map((tab) => {
                    const Icon = tab.icon
                    return (
                      <button
                        key={tab.id}
                        onClick={() => {
                          setActiveTab(tab.id)
                          setIsMobileMenuOpen(false)
                        }}
                        className={`flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm flex items-center space-x-2 transition-all whitespace-nowrap touch-target ${activeTab === tab.id
                          ? "bg-gradient-to-r from-blue-500 to-purple-500 text-white"
                          : "bg-gray-100 text-gray-600"
                          }`}
                      >
                        <Icon className="w-4 h-4" />
                        <span>{tab.label}</span>
                      </button>
                    )
                  })}

                  {/* Bot√£o de logout no mobile */}
                  <button
                    onClick={() => {
                      onLogout()
                      setIsMobileMenuOpen(false)
                    }}
                    className="flex-shrink-0 px-4 py-2 rounded-xl font-bold text-sm flex items-center space-x-2 transition-all text-white whitespace-nowrap touch-target"
                    style={{ backgroundColor: "#AEE1F9" }}
                  >
                    <LogOut className="w-4 h-4" />
                    <span>Sair</span>
                  </button>
                </nav>
              </div>
            </div>
          )}
        </div>
      </header>

      {/* Content */}
      <main className="max-w-6xl mx-auto px-2 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6 overflow-x-hidden">
        {activeTab === "gerenciar" && <GerenciamentoDuplas torneio={torneio} />}
        {activeTab === "duplas" && <GerenciamentoDuplasCompleto torneio={torneio} />}
        {activeTab === "rodadas" && <GerenciamentoRodadas torneio={torneio} />}
        {activeTab === "bonus" && <GerenciamentoBonus torneio={torneio} />}
        {activeTab === "rankings" && <RankingsManager torneio={torneio} />}
        {activeTab === "loja" && <LojaManager torneio={torneio} />}
      </main>
    </div>
  )
}

function AlunoDashboard({ onLogout }: { onLogout: () => void }) {
  const [activeTab, setActiveTab] = useState("geral")
  const [menuOpen, setMenuOpen] = useState(false)
  const torneio = useTorneio()

  if (torneio.loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-cyan-200 via-blue-200 to-cyan-300 flex items-center justify-center">
        <Card className="p-8">
          <div className="text-center">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p className="text-lg font-semibold">Carregando dados do torneio...</p>
          </div>
        </Card>
      </div>
    )
  }

  // Calcular ranking geral diretamente das duplas
  const calcularRankingGeral = () => {
    console.log("üèÜ [AlunoDashboard] calcularRankingGeral - iniciando com duplas:", torneio.duplas.length);

    const resultado = [...torneio.duplas]
      .map(dupla => {
        // Calcular totais das rodadas
        const pontosRodadas = Object.values(dupla.pontosPorRodada || {})
          .reduce((total: number, pontos: any) => total + (Number(pontos) || 0), 0);
        const moedasRodadas = Object.values(dupla.moedasPorRodada || {})
          .reduce((total: number, moedas: any) => total + (Number(moedas) || 0), 0);
        const medalhasRodadas = Object.values(dupla.medalhasPorRodada || {})
          .reduce((total: number, medalhas: any) => total + (Number(medalhas) || 0), 0);

        // Calcular totais dos b√¥nus
        const pontosBonusTotal = Object.values(dupla.pontosPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, pontos: any) => subTotal + (Number(pontos) || 0), 0), 0
          );
        const moedasBonusTotal = Object.values(dupla.moedasPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, moedas: any) => subTotal + (Number(moedas) || 0), 0), 0
          );
        const medalhasBonusTotal = Object.values(dupla.medalhasPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, medalhas: any) => subTotal + (Number(medalhas) || 0), 0), 0
          );

        const resultado = {
          ...dupla,
          pontos: pontosRodadas + pontosBonusTotal,
          moedas: moedasRodadas + moedasBonusTotal,
          medalhas: medalhasRodadas + medalhasBonusTotal,
          pontosBonus: pontosBonusTotal,
          moedasBonus: moedasBonusTotal,
          medalhasBonus: medalhasBonusTotal
        };

        console.log(`üìä [AlunoDashboard] ${dupla.tag}: rodadas=${pontosRodadas}, bonus=${pontosBonusTotal}, total=${resultado.pontos}`);
        return resultado;
      })
      // Ordenar por pontos totais, depois por b√¥nus como desempate
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos totais
        if ((b.pontos || 0) !== (a.pontos || 0)) {
          return (b.pontos || 0) - (a.pontos || 0);
        }
        // Desempate por pontos de b√¥nus
        if ((b.pontosBonus || 0) !== (a.pontosBonus || 0)) {
          return (b.pontosBonus || 0) - (a.pontosBonus || 0);
        }
        // Desempate por medalhas totais
        if ((b.medalhas || 0) !== (a.medalhas || 0)) {
          return (b.medalhas || 0) - (a.medalhas || 0);
        }
        // Desempate por moedas totais
        return (b.moedas || 0) - (a.moedas || 0);
      });

    // Calcular posi√ß√µes com empates
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas s√£o diferentes da dupla anterior, avan√ßa a posi√ß√£o
        if (dupla.pontos !== anterior.pontos ||
          dupla.medalhas !== anterior.medalhas ||
          dupla.moedas !== anterior.moedas) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    console.log("üèÜ [AlunoDashboard] Ranking geral final:", resultadoComRanking.map(d => ({ tag: d.tag, posicao: d.posicao, pontos: d.pontos })));
    return resultadoComRanking;
  };

  // Calcular ranking por rodada diretamente das duplas
  const calcularRankingPorRodada = (rodadaId: string) => {
    console.log(`üéØ [AlunoDashboard] calcularRankingPorRodada - rodada: ${rodadaId}, duplas: ${torneio.duplas.length}`);

    const resultado = [...torneio.duplas]
      .map(dupla => {
        const pontosRodada = Number(dupla.pontosPorRodada?.[rodadaId]) || 0;
        const moedasRodada = Number(dupla.moedasPorRodada?.[rodadaId]) || 0;
        const medalhasRodada = Number(dupla.medalhasPorRodada?.[rodadaId]) || 0;

        // Calcular b√¥nus total para desempate
        const pontosBonusTotal = Object.values(dupla.pontosPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, pontos: any) => subTotal + (Number(pontos) || 0), 0), 0
          );

        console.log(`üìà [AlunoDashboard] ${dupla.tag} - rodada ${rodadaId}: pontos=${pontosRodada}, dados originais:`, dupla.pontosPorRodada);

        return {
          ...dupla,
          pontosRodada: isNaN(pontosRodada) ? 0 : pontosRodada,
          moedasRodada: isNaN(moedasRodada) ? 0 : moedasRodada,
          medalhasRodada: isNaN(medalhasRodada) ? 0 : medalhasRodada,
          pontosBonusTotal
        };
      })
      // Ordenar por pontos da rodada, depois por b√¥nus como desempate
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos da rodada
        if ((b.pontosRodada || 0) !== (a.pontosRodada || 0)) {
          return (b.pontosRodada || 0) - (a.pontosRodada || 0);
        }
        // Desempate por pontos de b√¥nus total
        if ((b.pontosBonusTotal || 0) !== (a.pontosBonusTotal || 0)) {
          return (b.pontosBonusTotal || 0) - (a.pontosBonusTotal || 0);
        }
        // Desempate por medalhas da rodada
        if ((b.medalhasRodada || 0) !== (a.medalhasRodada || 0)) {
          return (b.medalhasRodada || 0) - (a.medalhasRodada || 0);
        }
        // Desempate por moedas da rodada
        return (b.moedasRodada || 0) - (a.moedasRodada || 0);
      });

    // Calcular posi√ß√µes com empates para rodada
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas da rodada s√£o diferentes, avan√ßa a posi√ß√£o
        if (dupla.pontosRodada !== anterior.pontosRodada ||
          dupla.medalhasRodada !== anterior.medalhasRodada ||
          dupla.moedasRodada !== anterior.moedasRodada) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    console.log("üéØ [AlunoDashboard] Ranking por rodada final:", resultadoComRanking.map(d => ({ tag: d.tag, posicao: d.posicao, pontosRodada: d.pontosRodada })));
    return resultadoComRanking;
  };

  // Calcular ranking por b√¥nus diretamente das duplas  
  const calcularRankingPorBonus = (bonusId: string) => {
    const resultado = [...torneio.duplas]
      .map(dupla => {
        let pontosBonus = 0;
        let moedasBonus = 0;
        let medalhasBonus = 0;

        if (dupla.pontosPorBonus?.[bonusId]) {
          pontosBonus = Object.values(dupla.pontosPorBonus[bonusId])
            .reduce((total: number, pontos: any) => total + (Number(pontos) || 0), 0);
        }

        if (dupla.moedasPorBonus?.[bonusId]) {
          moedasBonus = Object.values(dupla.moedasPorBonus[bonusId])
            .reduce((total: number, moedas: any) => total + (Number(moedas) || 0), 0);
        }

        if (dupla.medalhasPorBonus?.[bonusId]) {
          medalhasBonus = Object.values(dupla.medalhasPorBonus[bonusId])
            .reduce((total: number, medalhas: any) => total + (Number(medalhas) || 0), 0);
        }

        return {
          ...dupla,
          pontosBonus: isNaN(pontosBonus) ? 0 : pontosBonus,
          moedasBonus: isNaN(moedasBonus) ? 0 : moedasBonus,
          medalhasBonus: isNaN(medalhasBonus) ? 0 : medalhasBonus
        };
      })
      // Ordenar por pontos de b√¥nus, depois por medalhas e moedas
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos de b√¥nus
        if ((b.pontosBonus || 0) !== (a.pontosBonus || 0)) {
          return (b.pontosBonus || 0) - (a.pontosBonus || 0);
        }
        // Desempate por medalhas de b√¥nus
        if ((b.medalhasBonus || 0) !== (a.medalhasBonus || 0)) {
          return (b.medalhasBonus || 0) - (a.medalhasBonus || 0);
        }
        // Desempate por moedas de b√¥nus
        return (b.moedasBonus || 0) - (a.moedasBonus || 0);
      });

    // Calcular posi√ß√µes com empates para b√¥nus
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas de b√¥nus s√£o diferentes, avan√ßa a posi√ß√£o
        if (dupla.pontosBonus !== anterior.pontosBonus ||
          dupla.medalhasBonus !== anterior.medalhasBonus ||
          dupla.moedasBonus !== anterior.moedasBonus) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    return resultadoComRanking;
  };

  const rankingGeral = calcularRankingGeral();
  const rodadas = torneio.rodadas

  return (
    <div className="min-h-screen bg-[url('/background.png')] bg-cover bg-center bg-no-repeat overflow-x-hidden">
      <header className="shadow-lg" style={{ backgroundColor: "#AEE1F9" }}>
        <div className="px-3 sm:px-6 lg:px-8">
          <div className="flex justify-around items-center py-3 sm:py-6">
            <div className="flex items-center space-x-2 sm:space-x-4">
              <img
                src="/Torneio_Jamboree.png"
                alt="Torneio Jamboree"
                className="h-8 sm:h-12 w-auto object-contain drop-shadow-lg"
              />
            </div>
            <div className="flex items-center space-x-2">
              <Button
                onClick={() => setActiveTab("loja")}
                className={`rounded-full px-3 py-2 sm:px-4 sm:py-3 font-bold text-xs sm:text-base flex items-center space-x-2 cursor-pointer transition-all duration-300 transform ${activeTab === "loja"
                  ? "bg-white text-blue-600 hover:bg-blue-50 hover:text-blue-700 hover:scale-105 hover:shadow-lg scale-105 shadow-lg"
                  : "bg-white text-blue-600 hover:bg-blue-50 hover:text-blue-700 hover:scale-105 hover:shadow-lg"
                  }`}
              >
                <img src="/shop_icon.png" alt="Loja" className="w-4 h-4" />
                <span className="hidden sm:inline">Lojinha</span>
              </Button>
              <Button
                onClick={onLogout}
                className="bg-slate-700 text-white border-0 rounded-full px-3 py-2 sm:px-6 sm:py-3 font-bold hover:bg-slate-800 text-xs sm:text-base flex items-center space-x-2 cursor-pointer"
              >
                <LogOut className="w-4 h-4" />
                <span className="hidden sm:inline">Sair</span>
              </Button>
            </div>
          </div>
        </div>
      </header>

      <main className="px-2 sm:px-4 lg:px-6 py-3 sm:py-6 lg:py-8 overflow-x-hidden max-w-7xl mx-auto justify-around">
        {/* Mobile Navigation */}
        <div className="mb-3 justify-around sm:mb-4 lg:mb-6">
          <div className="block sm:hidden">
            <Button
              onClick={() => setMenuOpen(!menuOpen)}
              className="w-full mb-3 bg-gray-300 text-gray-700 hover:bg-gray-400 rounded-full font-bold cursor-pointer"
            >
              {menuOpen ? <X className="w-4 h-4 mr-2" /> : <Menu className="w-4 h-4 mr-2" />}
              Menu
            </Button>
            {menuOpen && (
              <div className="grid grid-cols-1 gap-2 mb-4 overflow-x-hidden">
                <Button
                  onClick={() => {
                    setActiveTab("geral")
                    setMenuOpen(false)
                  }}
                  className={`rounded-full px-4 py-3 font-bold text-sm cursor-pointer ${activeTab === "geral"
                    ? "bg-gradient-to-r bg-[#AEE1F9] text-white"
                    : "bg-gray-300 text-black hover:bg-gray-400"
                    }`}
                >
                  Rank Geral
                </Button>
                {rodadas.map((rodada) => (
                  <Button
                    key={rodada.id}
                    onClick={() => {
                      setActiveTab(rodada.id)
                      setMenuOpen(false)
                    }}
                    className={`rounded-full px-4 py-3 font-bold text-sm cursor-pointer ${activeTab === rodada.id
                      ? "bg-gradient-to-r from-blue-600 to-blue-800 text-white"
                      : "bg-gray-300 text-black hover:bg-gray-400"
                      }`}
                  >
                    {rodada.nome}
                  </Button>
                ))}
                {torneio.bonus?.map((bonus: any) => (
                  <Button
                    key={bonus.id}
                    onClick={() => {
                      setActiveTab(bonus.id)
                      setMenuOpen(false)
                    }}
                    className={`rounded-full px-4 py-3 font-bold text-sm cursor-pointer ${activeTab === bonus.id
                      ? "bg-gradient-to-r from-yellow-400 to-orange-400 text-white"
                      : "bg-gray-300 text-black hover:bg-gray-400"
                      }`}
                  >
                    ‚≠ê B√îNUS - {bonus.nome}
                  </Button>
                ))}
              </div>
            )}
          </div>

          {/* Desktop Navigation */}
          <div className="hidden sm:block">
            <div className="overflow-x-auto custom-scrollbar">
              <div className="flex gap-2 pb-2 min-w-max scroll-smooth-x">
                <Button
                  onClick={() => setActiveTab("geral")}
                  className={`rounded-full px-3 sm:px-4 lg:px-6 py-2 sm:py-2 lg:py-3 font-bold text-xs sm:text-sm lg:text-base flex-shrink-0 touch-target cursor-pointer ${activeTab === "geral"
                    ? "bg-gradient-to-r bg-[#AEE1F9] text-white"
                    : "bg-gray-300 text-black hover:bg-gray-400"
                    }`}
                >
                  Rank Geral
                </Button>
                {rodadas.map((rodada) => (
                  <Button
                    key={rodada.id}
                    onClick={() => setActiveTab(rodada.id)}
                    className={`rounded-full px-3 sm:px-4 lg:px-6 py-2 sm:py-2 lg:py-3 font-bold text-xs sm:text-sm lg:text-base flex-shrink-0 touch-target cursor-pointer ${activeTab === rodada.id
                      ? "bg-gradient-to-r bg-[#AEE1F9] text-white"
                      : "bg-gray-300 text-black hover:bg-gray-400"
                      }`}
                  >
                    {rodada.nome}
                  </Button>
                ))}
                {torneio.bonus?.map((bonus: any) => (
                  <Button
                    key={bonus.id}
                    onClick={() => setActiveTab(bonus.id)}
                    className={`rounded-full px-3 sm:px-4 lg:px-6 py-2 sm:py-2 lg:py-3 font-bold text-xs sm:text-sm lg:text-base flex-shrink-0 touch-target cursor-pointer ${activeTab === bonus.id
                      ? "bg-gradient-to-r from-yellow-400 to-orange-400 text-white"
                      : "bg-gray-300 text-black hover:bg-gray-400"
                      }`}
                  >
                    ‚≠ê B√îNUS - {bonus.nome}
                  </Button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {activeTab === "geral" && <RankingTable title="Ranking Geral" data={rankingGeral} />}
        {rodadas.map((rodada) =>
          activeTab === rodada.id ? (
            <RankingTable
              key={rodada.id}
              title={rodada.nome}
              data={calcularRankingPorRodada(rodada.id)}
              showRoundPoints={true}
            />
          ) : null
        )}
        {torneio.bonus?.map((bonus: any) =>
          activeTab === bonus.id && (
            <RankingTable
              key={bonus.id}
              title={`B√îNUS - ${bonus.nome}`}
              data={calcularRankingPorBonus(bonus.id)}
              showBonusPoints={true}
            />
          )
        )}
        {activeTab === "loja" && <LojaView torneio={torneio} showComprarButton={false} />}
      </main>
    </div>
  )
}

// Componente para gerenciar b√¥nus
function GerenciamentoBonus({ torneio }: { torneio: any }) {
  const [nome, setNome] = useState("")
  const [descricao, setDescricao] = useState("")
  const [bonusSelecionado, setBonusSelecionado] = useState<string | null>(null)
  const [partidasBonus, setPartidasBonus] = useState<any[]>([])
  const [bonusParaExcluir, setBonusParaExcluir] = useState<string | null>(null)

  // Estados para cria√ß√£o de partidas
  const [nomePartida, setNomePartida] = useState("")
  const [descricaoPartida, setDescricaoPartida] = useState("")
  const [pontuacaoMaxima, setPontuacaoMaxima] = useState("0")
  const [multiplicadorPontos, setMultiplicadorPontos] = useState("0")
  const [multiplicadorMoedas, setMultiplicadorMoedas] = useState("0")
  const [multiplicadorMedalhas, setMultiplicadorMedalhas] = useState("0")

  // Estados para pontua√ß√£o
  const [duplaSelecionada, setDuplaSelecionada] = useState("")
  const [partidaSelecionada, setPartidaSelecionada] = useState("")
  const [pontosInseridos, setPontosInseridos] = useState("0")
  const [moedasInseridas, setMoedasInseridas] = useState("0")
  const [medalhasInseridas, setMedalhasInseridas] = useState("0")

  const handleCriarBonus = async () => {
    try {
      if (!nome || !descricao) {
        toast.error("Preencha todos os campos!")
        return
      }

      await torneio.criarBonus(nome, descricao)
      setNome("")
      setDescricao("")
      toast.success("B√¥nus criado com sucesso!")
    } catch (error) {
      console.error("Erro ao criar b√¥nus:", error)
      toast.error("Erro ao criar b√¥nus")
    }
  }

  const handleExcluirBonus = async (bonusId: string) => {
    try {
      const bonus = torneio.bonus.find((b: any) => b.id === bonusId)
      await torneio.excluirBonus(bonusId)
      setBonusParaExcluir(null)
      // Se o b√¥nus exclu√≠do estava selecionado, limpar sele√ß√£o
      if (bonusSelecionado === bonusId) {
        setBonusSelecionado(null)
        setPartidasBonus([])
      }
      toast.success(`B√¥nus "${bonus?.nome}" exclu√≠do com sucesso!`)
    } catch (error) {
      console.error('Erro ao excluir b√¥nus:', error)
      toast.error("Erro ao excluir b√¥nus!")
    }
  }

  const handleCriarPartida = async () => {
    try {
      if (!bonusSelecionado || !nomePartida || !descricaoPartida || !pontuacaoMaxima || !multiplicadorPontos) {
        toast.error("Preencha todos os campos da partida!")
        return
      }

      await torneio.criarPartidaBonus(
        bonusSelecionado,
        nomePartida,
        descricaoPartida,
        parseInt(pontuacaoMaxima),
        parseFloat(multiplicadorPontos),
        parseFloat(multiplicadorMoedas) || 1,
        parseFloat(multiplicadorMedalhas) || 1
      )

      setNomePartida("")
      setDescricaoPartida("")
      setPontuacaoMaxima("0")
      setMultiplicadorPontos("0")
      setMultiplicadorMoedas("0")
      setMultiplicadorMedalhas("0")

      // Recarregar partidas
      if (bonusSelecionado) {
        const partidas = await torneio.buscarPartidasBonus(bonusSelecionado)
        setPartidasBonus(partidas)
      }

      toast.success("Partida criada com sucesso!")
    } catch (error) {
      console.error("Erro ao criar partida:", error)
      toast.error("Erro ao criar partida")
    }
  }

  const handleAdicionarPontuacao = async () => {
    try {
      if (!duplaSelecionada || !partidaSelecionada || !pontosInseridos) {
        toast.error("Preencha pelo menos a dupla, partida e pontos!")
        return
      }

      await torneio.adicionarPontuacaoBonus(
        duplaSelecionada,
        bonusSelecionado,
        partidaSelecionada,
        parseInt(pontosInseridos),
        parseInt(moedasInseridas) || 0,
        parseInt(medalhasInseridas) || 0
      )

      setDuplaSelecionada("")
      setPartidaSelecionada("")
      setPontosInseridos("0")
      setMoedasInseridas("0")
      setMedalhasInseridas("0")

      toast.success("Pontua√ß√£o adicionada com sucesso!")
    } catch (error) {
      console.error("Erro ao adicionar pontua√ß√£o:", error)
      toast.error("Erro ao adicionar pontua√ß√£o")
    }
  }

  const carregarPartidasBonus = async (bonusId: string) => {
    try {
      const partidas = await torneio.buscarPartidasBonus(bonusId)
      setPartidasBonus(partidas)
    } catch (error) {
      console.error("Erro ao carregar partidas:", error)
    }
  }

  const handleSelecionarBonus = (bonusId: string) => {
    setBonusSelecionado(bonusId)
    carregarPartidasBonus(bonusId)
  }

  const calcularPontuacaoComMultiplicador = (pontos: number, moedas: number, medalhas: number, partida: any) => {
    return {
      pontos: pontos * (partida?.multiplicadorPontos || 1),
      moedas: moedas * (partida?.multiplicadorMoedas || 1),
      medalhas: medalhas * (partida?.multiplicadorMedalhas || 1)
    }
  }

  return (
    <div className="space-y-6">
      {/* Criar Novo B√¥nus */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Star className="w-5 h-5" />
            Criar Novo B√¥nus
          </CardTitle>
          <CardDescription>
            Crie tabelas de b√¥nus com multiplicadores para pontua√ß√µes especiais
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <Label htmlFor="nome">Nome do B√¥nus</Label>
            <Input
              id="nome"
              value={nome}
              onChange={(e) => setNome(e.target.value)}
              placeholder="Nome do b√¥nus"
            />
          </div>
          <div>
            <Label htmlFor="descricao">Descri√ß√£o</Label>
            <Textarea
              id="descricao"
              value={descricao}
              onChange={(e) => setDescricao(e.target.value)}
              placeholder="Descreva o b√¥nus..."
            />
          </div>
          <Button onClick={handleCriarBonus} className="w-full">
            <Plus className="w-4 h-4 mr-2" />
            Criar B√¥nus
          </Button>
        </CardContent>
      </Card>

      {/* Lista de B√¥nus Existentes */}
      <Card>
        <CardHeader>
          <CardTitle>B√¥nus Existentes</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {torneio.bonus.length === 0 ? (
              <p className="text-gray-500 text-center py-4">Nenhum b√¥nus criado ainda. Crie o primeiro b√¥nus!</p>
            ) : (
              torneio.bonus.map((bonus: any) => (
                <div
                  key={bonus.id}
                  className={`flex items-center justify-between p-4 border rounded-lg cursor-pointer transition-colors ${bonusSelecionado === bonus.id ? 'bg-blue-50 border-blue-300' : ''
                    }`}
                  onClick={() => handleSelecionarBonus(bonus.id)}
                >
                  <div>
                    <h3 className="font-medium">B√îNUS - {bonus.nome}</h3>
                    <p className="text-sm text-gray-600">{bonus.descricao}</p>
                  </div>
                  <div className="flex gap-2">
                    {!bonus.ativo && (
                      <Button
                        size="sm"
                        onClick={(e) => {
                          e.stopPropagation()
                          torneio.ativarBonus(bonus.id)
                        }}
                        className="rounded-full bg-green-500 hover:bg-green-600 text-white font-bold"
                      >
                        Ativar
                      </Button>
                    )}
                    {bonus.ativo && (
                      <Button
                        size="sm"
                        className="rounded-full bg-blue-500 hover:bg-blue-600 text-white font-bold"
                        disabled
                      >
                        Ativo
                      </Button>
                    )}
                    <Button
                      size="sm"
                      onClick={(e) => {
                        e.stopPropagation()
                        setBonusParaExcluir(bonus.id)
                      }}
                      variant="destructive"
                      className="rounded-full bg-red-500 hover:bg-red-600 text-white font-bold"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        </CardContent>
      </Card>

      {/* Gerenciar Partidas do B√¥nus Selecionado */}
      {bonusSelecionado && (
        <>
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Target className="w-5 h-5" />
                Adicionar Partida ao B√¥nus
              </CardTitle>
              <CardDescription>
                Crie at√© 3 partidas com multiplicadores para o b√¥nus selecionado
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="space-y-4 sm:space-y-0">
                {/* Container com scroll horizontal para mobile */}
                <div className="overflow-x-auto">
                  <div className="flex flex-col sm:grid sm:grid-cols-1 md:grid-cols-3 gap-4 min-w-full">
                    <div className="min-w-0">
                      <Label htmlFor="nomePartida">Nome da Partida</Label>
                      <Input
                        id="nomePartida"
                        value={nomePartida}
                        onChange={(e) => setNomePartida(e.target.value)}
                        placeholder="Nome da pontua√ß√£o"
                        className="w-full"
                      />
                    </div>
                    <div className="min-w-0">
                      <Label htmlFor="multiplicadorPontos">Multiplicador Pontos</Label>
                      <Input
                        id="multiplicadorPontos"
                        type="number"
                        step="0.1"
                        value={multiplicadorPontos}
                        onChange={(e) => setMultiplicadorPontos(e.target.value)}
                        placeholder="0"
                        className="w-full"
                      />
                    </div>
                    <div className="min-w-0">
                      <Label htmlFor="multiplicadorMoedas">Multiplicador Moedas</Label>
                      <Input
                        id="multiplicadorMoedas"
                        type="number"
                        step="0.1"
                        value={multiplicadorMoedas}
                        onChange={(e) => setMultiplicadorMoedas(e.target.value)}
                        placeholder="0"
                        className="w-full"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div className="space-y-4 sm:space-y-0">
                <div className="overflow-x-auto">
                  <div className="flex flex-col sm:grid sm:grid-cols-1 md:grid-cols-2 gap-4 min-w-full">
                    <div className="min-w-0">
                      <Label htmlFor="multiplicadorMedalhas">Multiplicador Medalhas</Label>
                      <Input
                        id="multiplicadorMedalhas"
                        type="number"
                        step="0.1"
                        value={multiplicadorMedalhas}
                        onChange={(e) => setMultiplicadorMedalhas(e.target.value)}
                        placeholder="0"
                        className="w-full"
                      />
                    </div>
                    <div className="min-w-0">
                      <Label htmlFor="pontuacaoMaxima">Pontua√ß√£o M√°xima</Label>
                      <Input
                        id="pontuacaoMaxima"
                        type="number"
                        value={pontuacaoMaxima}
                        onChange={(e) => setPontuacaoMaxima(e.target.value)}
                        placeholder="0"
                        className="w-full"
                      />
                    </div>
                  </div>
                </div>
              </div>
              <div>
                <Label htmlFor="descricaoPartida">Descri√ß√£o da Partida</Label>
                <Textarea
                  id="descricaoPartida"
                  value={descricaoPartida}
                  onChange={(e) => setDescricaoPartida(e.target.value)}
                  placeholder="Descreva a partida..."
                />
              </div>
              <Button
                onClick={handleCriarPartida}
                className="w-full"
                disabled={partidasBonus.length >= 3}
              >
                <Plus className="w-4 h-4 mr-2" />
                Adicionar Partida {partidasBonus.length >= 3 && "(M√°ximo atingido)"}
              </Button>
            </CardContent>
          </Card>

          {/* Lista de Partidas do B√¥nus */}
          <Card>
            <CardHeader>
              <CardTitle>Partidas do B√¥nus</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                {partidasBonus.length === 0 ? (
                  <p className="text-gray-500 text-center py-4">Nenhuma partida criada ainda</p>
                ) : (
                  partidasBonus.map((partida: any) => (
                    <div
                      key={partida.id}
                      className="flex items-center justify-between p-4 border rounded-lg"
                    >
                      <div>
                        <h4 className="font-medium">{partida.nome}</h4>
                        <p className="text-sm text-gray-600">{partida.descricao}</p>
                        <p className="text-sm text-blue-600">
                          Multiplicadores: Pontos {partida.multiplicadorPontos}x | Moedas {partida.multiplicadorMoedas || 1}x | Medalhas {partida.multiplicadorMedalhas || 1}x
                        </p>
                        <p className="text-sm text-green-600">
                          Max: {partida.pontuacaoMaxima} pontos
                        </p>
                      </div>
                      <div className="flex gap-2">
                        <Button
                          size="sm"
                          variant={partida.ativa ? "default" : "outline"}
                          onClick={() => torneio.alternarStatusPartida(partida.id, !partida.ativa)}
                        >
                          {partida.ativa ? "Ativa" : "Inativa"}
                        </Button>
                        {!partida.finalizada && (
                          <Button
                            size="sm"
                            variant="destructive"
                            onClick={() => torneio.finalizarPartida(partida.id)}
                          >
                            Finalizar
                          </Button>
                        )}
                      </div>
                    </div>
                  ))
                )}
              </div>
            </CardContent>
          </Card>

          {/* Adicionar Pontua√ß√£o */}
          {partidasBonus.length > 0 && (
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center gap-2">
                  <Medal className="w-5 h-5" />
                  Adicionar Pontua√ß√£o
                </CardTitle>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-5 gap-4">
                  <div>
                    <Label htmlFor="duplaSelecionada">Selecionar Dupla</Label>
                    <Select value={duplaSelecionada} onValueChange={setDuplaSelecionada}>
                      <SelectTrigger>
                        <SelectValue placeholder="Escolha uma dupla" />
                      </SelectTrigger>
                      <SelectContent>
                        {torneio.duplas.map((dupla: any) => (
                          <SelectItem key={dupla.id} value={dupla.id}>
                            {dupla.tag}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="partidaSelecionada">Selecionar Partida</Label>
                    <Select value={partidaSelecionada} onValueChange={setPartidaSelecionada}>
                      <SelectTrigger>
                        <SelectValue placeholder="Escolha uma partida" />
                      </SelectTrigger>
                      <SelectContent>
                        {partidasBonus.filter(p => p.ativa && !p.finalizada).map((partida: any) => (
                          <SelectItem key={partida.id} value={partida.id}>
                            {partida.nome}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="pontosInseridos">Pontos Base</Label>
                    <Input
                      id="pontosInseridos"
                      type="number"
                      value={pontosInseridos}
                      onChange={(e) => setPontosInseridos(e.target.value)}
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <Label htmlFor="moedasInseridas">Moedas Base</Label>
                    <Input
                      id="moedasInseridas"
                      type="number"
                      value={moedasInseridas}
                      onChange={(e) => setMoedasInseridas(e.target.value)}
                      placeholder="0"
                    />
                  </div>
                  <div>
                    <Label htmlFor="medalhasInseridas">Medalhas Base</Label>
                    <Input
                      id="medalhasInseridas"
                      type="number"
                      value={medalhasInseridas}
                      onChange={(e) => setMedalhasInseridas(e.target.value)}
                      placeholder="0"
                    />
                  </div>
                </div>

                {(pontosInseridos || moedasInseridas || medalhasInseridas) && partidaSelecionada && (
                  <div className="p-3 bg-blue-50 rounded-lg">
                    <p className="text-sm text-blue-800 font-medium mb-2">
                      Valores finais com multiplicadores:
                    </p>
                    {(() => {
                      const partida = partidasBonus.find(p => p.id === partidaSelecionada);
                      if (!partida) return null;

                      const pontos = parseInt(pontosInseridos || "0");
                      const moedas = parseInt(moedasInseridas || "0");
                      const medalhas = parseInt(medalhasInseridas || "0");

                      const resultado = calcularPontuacaoComMultiplicador(pontos, moedas, medalhas, partida);

                      return (
                        <div className="space-y-1">
                          <p className="text-sm text-blue-700">
                            <strong>Pontos:</strong> {pontos} √ó {partida.multiplicadorPontos} = {resultado.pontos}
                          </p>
                          <p className="text-sm text-blue-700">
                            <strong>Moedas:</strong> {moedas} √ó {partida.multiplicadorMoedas || 1} = {resultado.moedas}
                          </p>
                          <p className="text-sm text-blue-700">
                            <strong>Medalhas:</strong> {medalhas} √ó {partida.multiplicadorMedalhas || 1} = {resultado.medalhas}
                          </p>
                        </div>
                      );
                    })()}
                  </div>
                )}

                <Button onClick={handleAdicionarPontuacao} className="w-full">
                  <Save className="w-4 h-4 mr-2" />
                  Adicionar Pontua√ß√£o
                </Button>
              </CardContent>
            </Card>
          )}
        </>
      )}

      {/* Dialog de confirma√ß√£o para exclus√£o */}
      <AlertDialog open={!!bonusParaExcluir} onOpenChange={() => setBonusParaExcluir(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Confirmar Exclus√£o</AlertDialogTitle>
            <AlertDialogDescription>
              {(() => {
                const bonus = torneio.bonus.find((b: any) => b.id === bonusParaExcluir);
                if (bonus?.ativo) {
                  return "ATEN√á√ÉO: Voc√™ est√° prestes a excluir o b√¥nus ATIVO! Esta a√ß√£o remover√° o b√¥nus atual do torneio e todos os dados associados ser√£o perdidos permanentemente. Tem certeza?";
                }
                return "Tem certeza que deseja excluir este b√¥nus? Esta a√ß√£o n√£o pode ser desfeita e todos os dados associados ser√£o perdidos permanentemente.";
              })()}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => bonusParaExcluir && handleExcluirBonus(bonusParaExcluir)}
              className="bg-red-500 hover:bg-red-600"
            >
              Excluir B√¥nus
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  )
}

// Componente para gerenciar duplas - Adicionar pontua√ß√£o
function GerenciamentoDuplas({ torneio }: { torneio: any }) {
  const [tag, setTag] = useState("")
  const [bannerFile, setBannerFile] = useState<File | null>(null)
  const [duplaId, setDuplaId] = useState("")
  const [pontos, setPontos] = useState("0")
  const [moedas, setMoedas] = useState("0")
  const [medalhas, setMedalhas] = useState("0")
  const [rodadaSelecionada, setRodadaSelecionada] = useState("")
  const [isCreating, setIsCreating] = useState(false)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [previewUrl, setPreviewUrl] = useState<string | null>(null)

  // Fun√ß√£o para limpar arquivo e preview
  const clearBannerFile = () => {
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
    }
    setBannerFile(null);
    setPreviewUrl(null);
    if (fileInputRef.current) {
      fileInputRef.current.value = '';
    }
  };

  // Criar preview quando arquivo for selecionado
  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0] || null;

    // Limpar preview anterior
    if (previewUrl) {
      URL.revokeObjectURL(previewUrl);
    }

    setBannerFile(file);
    if (file) {
      setPreviewUrl(URL.createObjectURL(file));
    } else {
      setPreviewUrl(null);
    }
  };

  // Cleanup do preview quando componente for desmontado
  useEffect(() => {
    return () => {
      if (previewUrl) {
        URL.revokeObjectURL(previewUrl);
      }
    };
  }, [previewUrl]);

  const handleAdicionarPontuacao = async () => {
    try {
      if (!duplaId || !pontos || !moedas || !medalhas || !rodadaSelecionada) {
        toast.error("Preencha todos os campos!")
        return
      }

      console.log("üéØ Adicionando pontua√ß√£o:", {
        duplaId,
        pontos: parseInt(pontos),
        moedas: parseInt(moedas),
        medalhas: parseInt(medalhas),
        rodada: rodadaSelecionada
      });

      await torneio.adicionarPontuacao(
        duplaId,
        parseInt(pontos),
        parseInt(moedas),
        parseInt(medalhas),
        rodadaSelecionada
      )

      console.log("‚úÖ Pontua√ß√£o adicionada com sucesso!");
      toast.success("Pontua√ß√£o adicionada com sucesso!")
      setPontos("0")
      setMoedas("0")
      setMedalhas("0")
    } catch (error) {
      console.error("‚ùå Erro ao adicionar pontua√ß√£o:", error);
      toast.error("Erro ao adicionar pontua√ß√£o")
    }
  }

  const handleCriarDupla = async () => {
    if (isCreating) {
      console.log("‚ö†Ô∏è Cria√ß√£o j√° em andamento, ignorando...");
      return;
    }

    console.log("üöÄ Iniciando cria√ß√£o de dupla...");
    setIsCreating(true);

    const timeoutId = setTimeout(() => {
      console.log("‚è∞ Timeout da opera√ß√£o!");
      toast.error("Opera√ß√£o demorou muito tempo. Tente novamente.");
      setIsCreating(false);
    }, 60000); // 60 segundos para upload local

    try {
      if (!tag) {
        toast.error("Preencha a tag da dupla!")
        return
      }

      if (tag.length < 2 || tag.length > 5) {
        toast.error("A tag deve ter entre 2 e 5 caracteres!")
        return
      }

      console.log("‚úÖ Valida√ß√µes iniciais OK");
      let bannerUrl = undefined;
      let loadingToastId = null;

      // Se h√° um arquivo de banner, fazer upload local
      if (bannerFile) {
        console.log("üìÅ Iniciando upload local de arquivo...", bannerFile.name);

        try {
          loadingToastId = toast.loading("Fazendo upload da imagem...");

          // Criar FormData para envio
          const formData = new FormData();
          formData.append('file', bannerFile);
          formData.append('tag', tag.toUpperCase());

          console.log("ÔøΩ Enviando arquivo para API local...");

          // Fazer upload via API local
          const response = await fetch('/api/upload', {
            method: 'POST',
            body: formData,
          });

          const result = await response.json();

          if (!result.success) {
            throw new Error(result.message || 'Erro no upload');
          }

          bannerUrl = result.imageUrl;
          console.log("‚úÖ Upload local conclu√≠do:", bannerUrl);

          if (loadingToastId) {
            toast.dismiss(loadingToastId);
            loadingToastId = null;
          }

        } catch (uploadError: any) {
          console.error("‚ùå Erro no upload local:", uploadError);
          if (loadingToastId) {
            toast.dismiss(loadingToastId);
          }

          const errorMessage = uploadError?.message || "Erro desconhecido no upload";
          toast.error(`Erro ao fazer upload: ${errorMessage}`);
          return;
        }
      }

      // Criar dupla com ou sem banner
      console.log("üë• Criando dupla no banco...", { tag: tag.toUpperCase(), bannerUrl });
      await torneio.criarDupla(tag.toUpperCase(), bannerUrl);
      console.log("‚úÖ Dupla criada com sucesso!");

      clearTimeout(timeoutId);
      toast.success("Dupla criada com sucesso!");
      setTag("");
      clearBannerFile();

    } catch (error) {
      console.error("‚ùå Erro geral ao criar dupla:", error);
      clearTimeout(timeoutId);
      toast.error("Erro ao criar dupla");
    } finally {
      setIsCreating(false);
    }
  }

  return (
    <div className="space-y-4 sm:space-y-6 max-w-4xl mx-auto">
      {/* Criar Nova Dupla */}
      <Card className="border-0 shadow-lg sm:shadow-xl lg:shadow-2xl bg-white rounded-xl sm:rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-green-400 to-emerald-400 text-white px-3 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6">
          <CardTitle className="text-lg sm:text-xl lg:text-2xl font-black flex items-center space-x-2">
            <Plus className="w-5 h-5 sm:w-6 sm:h-6" />
            <span>Criar Nova Dupla</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="p-3 sm:p-4 lg:p-6">
          <div className="space-y-3 sm:space-y-4">
            <div className="space-y-3">
              <div>
                <Label className="font-bold text-gray-700 text-sm">Tag da Dupla (2-5 caracteres)</Label>
                <Input
                  placeholder="Nome da dupla (TAG)"
                  value={tag}
                  onChange={(e) => setTag(e.target.value.slice(0, 5).toUpperCase())}
                  className="rounded-full border-2 border-gray-300 h-10 sm:h-12 w-full text-sm sm:text-base"
                  maxLength={5}
                />
              </div>
              <div>
                <Label className="font-bold text-gray-700 text-sm">Banner da Dupla</Label>
                <Input
                  ref={fileInputRef}
                  type="file"
                  accept="image/*"
                  onChange={handleFileChange}
                  className="rounded-full border-2 border-gray-300 h-10 sm:h-12 w-full text-sm sm:text-base file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                <p className="text-xs text-gray-500 mt-1">üí° Recomenda√ß√£o: 700x200 pixels para melhor visualiza√ß√£o (opcional)</p>
                <p className="text-xs text-green-600 mt-1">‚úÖ Arquivos de at√© 50MB s√£o suportados</p>
                {bannerFile && (
                  <div className="mt-3 space-y-2">
                    <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg border border-green-200">
                      <p className="text-sm text-green-700 font-medium">‚úÖ {bannerFile.name}</p>
                      <button
                        type="button"
                        onClick={clearBannerFile}
                        className="text-xs text-red-600 hover:text-red-800 font-medium px-2 py-1 rounded bg-red-50 hover:bg-red-100"
                      >
                        Remover
                      </button>
                    </div>
                    {previewUrl && (
                      <div className="relative">
                        <img
                          src={previewUrl}
                          alt="Preview do banner"
                          className="w-full max-w-md h-24 object-cover rounded-lg border-2 border-gray-200"
                        />
                        <p className="text-xs text-gray-500 mt-1">Preview do banner</p>
                      </div>
                    )}
                  </div>
                )}
              </div>
            </div>
          </div>
          <Button
            onClick={handleCriarDupla}
            disabled={isCreating || !tag || tag.length < 2 || tag.length > 5}
            className="w-full h-10 sm:h-12 rounded-full font-bold bg-gradient-to-r from-green-400 to-emerald-400 hover:from-green-500 hover:to-emerald-500 text-white mt-3 sm:mt-4 text-sm sm:text-base disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {isCreating ? (
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                CRIANDO...
              </div>
            ) : (
              "CRIAR DUPLA"
            )}
          </Button>
        </CardContent>
      </Card>

      {/* Adicionar Pontua√ß√£o */}
      <Card className="border-0 shadow-lg sm:shadow-xl lg:shadow-2xl bg-white rounded-xl sm:rounded-2xl overflow-hidden">
        <CardHeader className="text-white px-3 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6" style={{ backgroundColor: "#AEE1F9" }}>
          <CardTitle className="text-lg sm:text-xl lg:text-2xl font-black flex items-center space-x-2">
            <Target className="w-5 h-5 sm:w-6 sm:h-6" />
            <span>Adicionar Pontua√ß√£o</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="p-3 sm:p-4 lg:p-6">
          <div className="space-y-3 sm:space-y-4">
            <div>
              <Label className="font-bold text-gray-700 text-sm">Selecionar Dupla</Label>
              <Select value={duplaId} onValueChange={setDuplaId}>
                <SelectTrigger className="h-10 sm:h-12 rounded-full border-2 border-gray-300 text-sm sm:text-base">
                  <SelectValue placeholder="Escolha uma dupla" />
                </SelectTrigger>
                <SelectContent>
                  {torneio.duplas.map((dupla: Dupla) => (
                    <SelectItem key={dupla.id} value={dupla.id}>
                      {dupla.tag}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="overflow-x-auto">
              <div className="flex flex-col sm:flex-row gap-3 sm:gap-4 min-w-full">
                <div className="flex-1 min-w-0">
                  <Label className="font-bold text-gray-700 text-sm">Pontos</Label>
                  <Input
                    type="number"
                    placeholder="0"
                    value={pontos}
                    onChange={(e) => setPontos(e.target.value)}
                    className="rounded-full border-2 border-gray-300 h-10 sm:h-12 w-full text-sm sm:text-base"
                  />
                </div>
                <div className="flex-1 min-w-0">
                  <Label className="font-bold text-gray-700 text-sm">Moedas</Label>
                  <Input
                    type="number"
                    placeholder="0"
                    value={moedas}
                    onChange={(e) => setMoedas(e.target.value)}
                    className="rounded-full border-2 border-gray-300 h-10 sm:h-12 w-full text-sm sm:text-base"
                  />
                </div>
                <div className="flex-1 min-w-0">
                  <Label className="font-bold text-gray-700 text-sm">Medalhas</Label>
                  <Input
                    type="number"
                    placeholder="0"
                    value={medalhas}
                    onChange={(e) => setMedalhas(e.target.value)}
                    className="rounded-full border-2 border-gray-300 h-10 sm:h-12 w-full text-sm sm:text-base"
                  />
                </div>
              </div>
            </div>

            <div>
              <Label className="font-bold text-gray-700">Rodada</Label>
              <Select value={rodadaSelecionada} onValueChange={setRodadaSelecionada}>
                <SelectTrigger className="h-12 rounded-full border-2 border-gray-300">
                  <SelectValue placeholder="Selecione a rodada" />
                </SelectTrigger>
                <SelectContent>
                  {torneio.rodadas.map((rodada: any) => (
                    <SelectItem key={rodada.id} value={rodada.id}>
                      {rodada.nome}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <Button onClick={handleAdicionarPontuacao} className="w-full h-12 rounded-full font-bold text-white" style={{ backgroundColor: "#AEE1F9" }}>
              ADICIONAR PONTUA√á√ÉO
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Ferramentas Administrativas */}
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-orange-400 to-red-400 text-white px-6 py-6">
          <CardTitle className="text-2xl font-black flex items-center space-x-2">
            <Settings className="w-6 h-6" />
            <span>Ferramentas Administrativas</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
              <h3 className="font-bold text-yellow-800 mb-2">Sincronizar Totais</h3>
              <p className="text-sm text-yellow-700 mb-4">
                Recalcula e sincroniza os totais de todas as duplas (rodadas + b√¥nus).
                Use se houver inconsist√™ncias nos rankings.
              </p>
              <Button
                onClick={async () => {
                  try {
                    await torneio.sincronizarTodosTotais();
                    toast.success("Totais sincronizados com sucesso!");
                  } catch (error) {
                    toast.error("Erro ao sincronizar totais");
                  }
                }}
                className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-yellow-400 to-orange-400 hover:from-yellow-500 hover:to-orange-500 text-white"
              >
                SINCRONIZAR TODOS OS TOTAIS
              </Button>
            </div>

            <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
              <h3 className="font-bold text-green-800 mb-2">Recalcular Totais (Novo)</h3>
              <p className="text-sm text-green-700 mb-4">
                Recalcula totais usando a nova fun√ß√£o otimizada que processa rodadas + b√¥nus de uma vez.
              </p>
              <Button
                onClick={async () => {
                  try {
                    await torneio.recalcularTodosTotais('torneio-escolar-2024');
                    toast.success("Totais recalculados com sucesso!");
                  } catch (error) {
                    toast.error("Erro ao recalcular totais");
                  }
                }}
                className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-green-400 to-emerald-400 hover:from-green-500 hover:to-emerald-500 text-white"
              >
                RECALCULAR TOTAIS (NOVO)
              </Button>
            </div>

            <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
              <h3 className="font-bold text-blue-800 mb-2">Diagn√≥stico de Dados</h3>
              <p className="text-sm text-blue-700 mb-4">
                Exibe informa√ß√µes detalhadas das duplas no console para debugging.
              </p>
              <Button
                onClick={() => {
                  console.log("=== DIAGN√ìSTICO DE DUPLAS ===");
                  torneio.duplas.forEach((dupla: any, index: number) => {
                    console.log(`\nDupla ${index + 1}: ${dupla.tag}`);
                    console.log("Totais armazenados:", {
                      pontos: dupla.pontos,
                      moedas: dupla.moedas,
                      medalhas: dupla.medalhas
                    });
                    console.log("Por rodada:", {
                      pontos: dupla.pontosPorRodada,
                      moedas: dupla.moedasPorRodada,
                      medalhas: dupla.medalhasPorRodada
                    });
                    console.log("Por b√¥nus:", {
                      pontos: dupla.pontosPorBonus,
                      moedas: dupla.moedasPorBonus,
                      medalhas: dupla.medalhasPorBonus
                    });
                  });
                  toast.success("Dados exibidos no console!");
                }}
                className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-blue-400 to-cyan-400 hover:from-blue-500 hover:to-cyan-500 text-white"
              >
                DIAGNOSTICAR DADOS
              </Button>
            </div>

            <div className="p-4 bg-purple-50 border border-purple-200 rounded-lg">
              <h3 className="font-bold text-purple-800 mb-2">Debug Rankings</h3>
              <p className="text-sm text-purple-700 mb-4">
                Exibe informa√ß√µes de debug sobre o c√°lculo dos rankings no console.
              </p>
              <Button
                onClick={() => {
                  console.log("=== DEBUG RANKINGS ===");
                  console.log("1. Duplas originais:", torneio.duplas);
                  console.log("2. Ranking Geral:", torneio.getRankingGeral());
                  if (torneio.rodadas.length > 0) {
                    torneio.rodadas.forEach((rodada: any) => {
                      console.log(`3. Ranking Rodada ${rodada.nome} (${rodada.id}):`, torneio.getRankingPorRodada(rodada.id));
                    });
                  }
                  toast.success("Informa√ß√µes de debug no console!");
                }}
                className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-purple-400 to-pink-400 hover:from-purple-500 hover:to-pink-500 text-white"
              >
                DEBUG RANKINGS
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

// Componente para gerenciar todas as duplas
function GerenciamentoDuplasCompleto({ torneio }: { torneio: any }) {
  const [duplaParaRemover, setDuplaParaRemover] = useState<string | null>(null)

  const handleRemoverDupla = async (duplaId: string) => {
    try {
      const dupla = torneio.duplas.find((d: Dupla) => d.id === duplaId)
      await torneio.removerDupla(duplaId)
      setDuplaParaRemover(null)
      toast.success(`Dupla "${dupla?.tag}" removida com sucesso!`)
    } catch (error) {
      console.error('Erro ao remover dupla:', error)
      toast.error("Erro ao remover dupla!")
    }
  }

  return (
    <div className="space-y-6">
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="text-white px-6 py-6" style={{ backgroundColor: "#AEE1F9" }}>
          <CardTitle className="text-2xl font-black flex items-center space-x-2">
            <Users className="w-6 h-6" />
            <span>Todas as Duplas</span>
          </CardTitle>
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            {torneio.duplas.length === 0 ? (
              <div className="text-center py-8">
                <Users className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                <h3 className="text-lg font-bold text-gray-600 mb-2">Nenhuma dupla cadastrada</h3>
                <p className="text-gray-500 text-sm">Cadastre a primeira dupla para come√ßar o torneio!</p>
                <p className="text-gray-500">Use o formul√°rio acima para criar a primeira dupla</p>
              </div>
            ) : (
              torneio.duplas.map((dupla: Dupla) => (
                <div key={dupla.id} className="p-4 rounded-xl border-2 flex justify-between items-center" style={{ backgroundColor: "#F0F8FF", borderColor: "#AEE1F9" }}>
                  <div className="flex items-center gap-4">
                    <div className="w-16 h-16 rounded-lg overflow-hidden flex-shrink-0">
                      <BannerDupla 
                        dupla={dupla} 
                        className="w-full h-full text-sm"
                      />
                    </div>
                    <div>
                      <h3 className="font-black text-lg text-gray-800">{dupla.tag}</h3>
                      <p className="text-sm text-gray-600 font-semibold">
                        {dupla.pontos} pontos ‚Ä¢ {dupla.moedas} moedas ‚Ä¢ {dupla.medalhas} medalhas
                      </p>
                      <p className="text-xs text-gray-500">Status: {dupla.status}</p>
                    </div>
                  </div>
                  <div className="flex space-x-2">
                    <Button
                      onClick={() => torneio.atualizarStatusDupla(dupla.id, 'aguardando')}
                      size="sm"
                      className="rounded-full bg-yellow-500 hover:bg-yellow-600 text-white cursor-pointer"
                    >
                      Aguardando
                    </Button>
                    <Button
                      onClick={() => torneio.atualizarStatusDupla(dupla.id, 'ativa')}
                      size="sm"
                      className="rounded-full bg-green-500 hover:bg-green-600 text-white cursor-pointer"
                    >
                      Ativar
                    </Button>
                    {duplaParaRemover === dupla.id ? (
                      <div className="flex space-x-2 items-center">
                        <span className="text-sm font-semibold text-red-600 mr-2">Confirmar remo√ß√£o?</span>
                        <Button
                          onClick={() => handleRemoverDupla(dupla.id)}
                          size="sm"
                          className="rounded-full text-white cursor-pointer"
                          style={{ backgroundColor: "#AEE1F9" }}
                        >
                          Sim
                        </Button>
                        <Button
                          onClick={() => setDuplaParaRemover(null)}
                          size="sm"
                          className="rounded-full bg-gray-500 hover:bg-gray-600 text-white cursor-pointer"
                        >
                          N√£o
                        </Button>
                      </div>
                    ) : (
                      <Button
                        onClick={() => setDuplaParaRemover(dupla.id)}
                        size="sm"
                        className="rounded-full text-white cursor-pointer flex items-center space-x-1"
                        style={{ backgroundColor: "#AEE1F9" }}
                      >
                        <Trash2 className="w-3 h-3" />
                        <span>Remover</span>
                      </Button>
                    )}
                  </div>
                </div>
              ))
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

// Componente para mostrar rankings
function RankingsManager({ torneio }: { torneio: any }) {
  const [activeTab, setActiveTab] = useState("geral")

  // Calcular ranking geral diretamente das duplas
  const calcularRankingGeral = () => {
    const resultado = [...torneio.duplas]
      .map(dupla => {
        // Calcular totais das rodadas
        const pontosRodadas = Object.values(dupla.pontosPorRodada || {})
          .reduce((total: number, pontos: any) => total + (Number(pontos) || 0), 0);
        const moedasRodadas = Object.values(dupla.moedasPorRodada || {})
          .reduce((total: number, moedas: any) => total + (Number(moedas) || 0), 0);
        const medalhasRodadas = Object.values(dupla.medalhasPorRodada || {})
          .reduce((total: number, medalhas: any) => total + (Number(medalhas) || 0), 0);

        // Calcular totais dos b√¥nus
        const pontosBonusTotal = Object.values(dupla.pontosPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, pontos: any) => subTotal + (Number(pontos) || 0), 0), 0
          );
        const moedasBonusTotal = Object.values(dupla.moedasPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, moedas: any) => subTotal + (Number(moedas) || 0), 0), 0
          );
        const medalhasBonusTotal = Object.values(dupla.medalhasPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, medalhas: any) => subTotal + (Number(medalhas) || 0), 0), 0
          );

        return {
          ...dupla,
          pontos: pontosRodadas + pontosBonusTotal,
          moedas: moedasRodadas + moedasBonusTotal,
          medalhas: medalhasRodadas + medalhasBonusTotal,
          pontosBonus: pontosBonusTotal,
          moedasBonus: moedasBonusTotal,
          medalhasBonus: medalhasBonusTotal
        };
      })
      // Ordenar por pontos totais, depois por b√¥nus como desempate
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos totais
        if ((b.pontos || 0) !== (a.pontos || 0)) {
          return (b.pontos || 0) - (a.pontos || 0);
        }
        // Desempate por pontos de b√¥nus
        if ((b.pontosBonus || 0) !== (a.pontosBonus || 0)) {
          return (b.pontosBonus || 0) - (a.pontosBonus || 0);
        }
        // Desempate por medalhas totais
        if ((b.medalhas || 0) !== (a.medalhas || 0)) {
          return (b.medalhas || 0) - (a.medalhas || 0);
        }
        // Desempate por moedas totais
        return (b.moedas || 0) - (a.moedas || 0);
      });

    // Calcular posi√ß√µes com empates
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas s√£o diferentes da dupla anterior, avan√ßa a posi√ß√£o
        if (dupla.pontos !== anterior.pontos ||
          dupla.medalhas !== anterior.medalhas ||
          dupla.moedas !== anterior.moedas) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    return resultadoComRanking;
  };

  // Calcular ranking por rodada diretamente das duplas
  const calcularRankingPorRodada = (rodadaId: string) => {
    const resultado = [...torneio.duplas]
      .map(dupla => {
        const pontosRodada = Number(dupla.pontosPorRodada?.[rodadaId]) || 0;
        const moedasRodada = Number(dupla.moedasPorRodada?.[rodadaId]) || 0;
        const medalhasRodada = Number(dupla.medalhasPorRodada?.[rodadaId]) || 0;

        // Calcular b√¥nus total para desempate
        const pontosBonusTotal = Object.values(dupla.pontosPorBonus || {})
          .reduce((total: number, bonusPartidas: any) =>
            total + Object.values(bonusPartidas || {})
              .reduce((subTotal: number, pontos: any) => subTotal + (Number(pontos) || 0), 0), 0
          );

        return {
          ...dupla,
          pontosRodada: isNaN(pontosRodada) ? 0 : pontosRodada,
          moedasRodada: isNaN(moedasRodada) ? 0 : moedasRodada,
          medalhasRodada: isNaN(medalhasRodada) ? 0 : medalhasRodada,
          pontosBonusTotal
        };
      })
      // Ordenar por pontos da rodada, depois por b√¥nus como desempate
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos da rodada
        if ((b.pontosRodada || 0) !== (a.pontosRodada || 0)) {
          return (b.pontosRodada || 0) - (a.pontosRodada || 0);
        }
        // Desempate por pontos de b√¥nus total
        if ((b.pontosBonusTotal || 0) !== (a.pontosBonusTotal || 0)) {
          return (b.pontosBonusTotal || 0) - (a.pontosBonusTotal || 0);
        }
        // Desempate por medalhas da rodada
        if ((b.medalhasRodada || 0) !== (a.medalhasRodada || 0)) {
          return (b.medalhasRodada || 0) - (a.medalhasRodada || 0);
        }
        // Desempate por moedas da rodada
        return (b.moedasRodada || 0) - (a.moedasRodada || 0);
      });

    // Calcular posi√ß√µes com empates para rodada
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas da rodada s√£o diferentes, avan√ßa a posi√ß√£o
        if (dupla.pontosRodada !== anterior.pontosRodada ||
          dupla.medalhasRodada !== anterior.medalhasRodada ||
          dupla.moedasRodada !== anterior.moedasRodada) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    return resultadoComRanking;
  };

  // Calcular ranking por b√¥nus diretamente das duplas  
  const calcularRankingPorBonus = (bonusId: string) => {
    const resultado = [...torneio.duplas]
      .map(dupla => {
        let pontosBonus = 0;
        let moedasBonus = 0;
        let medalhasBonus = 0;

        if (dupla.pontosPorBonus?.[bonusId]) {
          pontosBonus = Object.values(dupla.pontosPorBonus[bonusId])
            .reduce((total: number, pontos: any) => total + (Number(pontos) || 0), 0);
        }

        if (dupla.moedasPorBonus?.[bonusId]) {
          moedasBonus = Object.values(dupla.moedasPorBonus[bonusId])
            .reduce((total: number, moedas: any) => total + (Number(moedas) || 0), 0);
        }

        if (dupla.medalhasPorBonus?.[bonusId]) {
          medalhasBonus = Object.values(dupla.medalhasPorBonus[bonusId])
            .reduce((total: number, medalhas: any) => total + (Number(medalhas) || 0), 0);
        }

        return {
          ...dupla,
          pontosBonus: isNaN(pontosBonus) ? 0 : pontosBonus,
          moedasBonus: isNaN(moedasBonus) ? 0 : moedasBonus,
          medalhasBonus: isNaN(medalhasBonus) ? 0 : medalhasBonus
        };
      })
      // Ordenar por pontos de b√¥nus, depois por medalhas e moedas
      .sort((a, b) => {
        // Primeiro crit√©rio: pontos de b√¥nus
        if ((b.pontosBonus || 0) !== (a.pontosBonus || 0)) {
          return (b.pontosBonus || 0) - (a.pontosBonus || 0);
        }
        // Desempate por medalhas de b√¥nus
        if ((b.medalhasBonus || 0) !== (a.medalhasBonus || 0)) {
          return (b.medalhasBonus || 0) - (a.medalhasBonus || 0);
        }
        // Desempate por moedas de b√¥nus
        return (b.moedasBonus || 0) - (a.moedasBonus || 0);
      });

    // Calcular posi√ß√µes com empates para b√¥nus
    let posicaoAtual = 1;
    const resultadoComRanking = resultado.map((dupla, index) => {
      if (index > 0) {
        const anterior = resultado[index - 1];
        // Se pontos, medalhas e moedas de b√¥nus s√£o diferentes, avan√ßa a posi√ß√£o
        if (dupla.pontosBonus !== anterior.pontosBonus ||
          dupla.medalhasBonus !== anterior.medalhasBonus ||
          dupla.moedasBonus !== anterior.moedasBonus) {
          posicaoAtual = index + 1;
        }
        // Se s√£o iguais, mant√©m a mesma posi√ß√£o (empate)
      }

      return {
        ...dupla,
        posicao: posicaoAtual
      };
    });

    return resultadoComRanking;
  };

  const rankingGeral = calcularRankingGeral();
  const rodadas = torneio.rodadas;
  const bonus = torneio.bonus;

  return (
    <div className="space-y-6">
      {/* Navega√ß√£o dos Rankings */}
      <div className="flex flex-wrap gap-2">
        <Button
          onClick={() => setActiveTab("geral")}
          className={`rounded-full px-6 py-3 font-bold ${activeTab === "geral"
            ? "bg-gradient-to-r from-blue-600 to-blue-800 text-white"
            : "bg-gray-300 text-black hover:bg-gray-400"
            }`}
        >
          Ranking Geral
        </Button>
        {rodadas.map((rodada: any) => (
          <Button
            key={rodada.id}
            onClick={() => setActiveTab(rodada.id)}
            className={`rounded-full px-6 py-3 font-bold ${activeTab === rodada.id
              ? "bg-gradient-to-r from-blue-600 to-blue-800 text-white"
              : "bg-gray-300 text-black hover:bg-gray-400"
              }`}
          >
            {rodada.nome}
          </Button>
        ))}
        {bonus.map((bonusItem: any) => (
          <Button
            key={`bonus-${bonusItem.id}`}
            onClick={() => setActiveTab(`bonus-${bonusItem.id}`)}
            className={`rounded-full px-6 py-3 font-bold ${activeTab === `bonus-${bonusItem.id}`
              ? "bg-gradient-to-r from-blue-600 to-blue-800 text-white"
              : "bg-gray-300 text-black hover:bg-gray-400"
              }`}
          >
            ‚≠ê B√îNUS - {bonusItem.nome}
          </Button>
        ))}
      </div>

      {/* Tabelas de Ranking */}
      {activeTab === "geral" && <RankingTable title="Ranking Geral" data={rankingGeral} />}
      {rodadas.map((rodada: any) =>
        activeTab === rodada.id ? (
          <RankingTable
            key={rodada.id}
            title={rodada.nome}
            data={calcularRankingPorRodada(rodada.id)}
            showRoundPoints={true}
          />
        ) : null
      )}
      {bonus.map((bonusItem: any) =>
        activeTab === `bonus-${bonusItem.id}` && (
          <RankingTable
            key={`bonus-table-${bonusItem.id}`}
            title={`B√îNUS - ${bonusItem.nome}`}
            data={calcularRankingPorBonus(bonusItem.id)}
            showBonusPoints={true}
          />
        )
      )}
    </div>
  )
}

// Componente para gerenciar a loja
function LojaManager({ torneio }: { torneio: any }) {
  const [nome, setNome] = useState("")
  const [descricao, setDescricao] = useState("")
  const [preco, setPreco] = useState("")
  const [quantidade, setQuantidade] = useState("")
  const [rodadaSelecionada, setRodadaSelecionada] = useState("")
  const [itemEditando, setItemEditando] = useState<any>(null)
  const [modoEdicao, setModoEdicao] = useState(false)
  const [imagemArquivo, setImagemArquivo] = useState<File | null>(null)
  const [imagemPreview, setImagemPreview] = useState<string>("")
  const [uploadandoImagem, setUploadandoImagem] = useState(false)

  const handleImagemChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const arquivo = e.target.files?.[0]
    if (arquivo) {
      setImagemArquivo(arquivo)
      
      // Criar preview
      const reader = new FileReader()
      reader.onloadend = () => {
        setImagemPreview(reader.result as string)
      }
      reader.readAsDataURL(arquivo)
    }
  }

  const uploadImagem = async (): Promise<string | undefined> => {
    if (!imagemArquivo) return undefined

    try {
      setUploadandoImagem(true)
      
      const formData = new FormData()
      formData.append('file', imagemArquivo)
      formData.append('tag', 'ITEM')
      formData.append('type', 'item')

      const response = await fetch('/api/upload', {
        method: 'POST',
        body: formData,
      })

      const result = await response.json()

      if (result.success) {
        return result.imageUrl
      } else {
        toast.error(result.message || 'Erro no upload da imagem')
        return undefined
      }
    } catch (error) {
      console.error('Erro no upload:', error)
      toast.error('Erro no upload da imagem')
      return undefined
    } finally {
      setUploadandoImagem(false)
    }
  }

  const limparImagem = () => {
    setImagemArquivo(null)
    setImagemPreview("")
  }

  const handleAdicionarItem = async () => {
    try {
      if (!nome || !descricao || !preco || !quantidade || !rodadaSelecionada) {
        toast.error("Preencha todos os campos!")
        return
      }

      // Upload da imagem se houver
      let imagemUrl: string | undefined = undefined
      if (imagemArquivo) {
        imagemUrl = await uploadImagem()
        if (!imagemUrl) return // Se falhou no upload, para a execu√ß√£o
      }

      await torneio.adicionarItemLoja(nome, descricao, parseInt(preco), rodadaSelecionada, parseInt(quantidade), imagemUrl)
      toast.success("Item adicionado com sucesso!")
      setNome("")
      setDescricao("")
      setPreco("")
      setQuantidade("")
      limparImagem()
    } catch (error) {
      toast.error("Erro ao adicionar item")
    }
  }

  const handleEditarItem = (item: any) => {
    setItemEditando(item)
    setNome(item.nome)
    setDescricao(item.descricao)
    setPreco(item.preco.toString())
    setQuantidade(item.quantidadeTotal?.toString() || "0")
    setRodadaSelecionada(item.rodada)
    
    // Carregar imagem atual se existir
    if (item.imagem) {
      setImagemPreview(item.imagem)
    } else {
      setImagemPreview("")
    }
    
    setModoEdicao(true)
  }

  const handleSalvarEdicao = async () => {
    try {
      if (!nome || !descricao || !preco || !quantidade || !rodadaSelecionada) {
        toast.error("Preencha todos os campos!")
        return
      }

      // Upload nova imagem se selecionada
      let imagemUrl: string | undefined = itemEditando.imagem // Manter a atual por padr√£o
      if (imagemArquivo) {
        const novaImagemUrl = await uploadImagem()
        if (novaImagemUrl) {
          imagemUrl = novaImagemUrl
        } else {
          return // Se falhou no upload, para a execu√ß√£o
        }
      }

      await torneio.editarItemLoja(itemEditando.id, nome, descricao, parseInt(preco), rodadaSelecionada, parseInt(quantidade), imagemUrl)
      toast.success("Item editado com sucesso!")
      handleCancelarEdicao()
    } catch (error) {
      toast.error("Erro ao editar item")
    }
  }

  const handleCancelarEdicao = () => {
    setModoEdicao(false)
    setItemEditando(null)
    setNome("")
    setDescricao("")
    setPreco("")
    setQuantidade("")
    setRodadaSelecionada("")
    limparImagem()
  }

  const handleRemoverItem = async (itemId: string) => {
    try {
      await torneio.removerItemLoja(itemId)
      toast.success("Item removido com sucesso!")
    } catch (error) {
      toast.error("Erro ao remover item")
    }
  }

  return (
    <div className="space-y-6">
      {/* Adicionar/Editar Item */}
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-slate-600 to-slate-800 text-white px-6 py-6">
          <CardTitle className="text-2xl font-black">
            {modoEdicao ? 'Editar Item da Loja' : 'Adicionar Item √† Loja Misteriosa'}
          </CardTitle>
          {modoEdicao && (
            <CardDescription className="text-slate-200 font-semibold">
              Editando: {itemEditando?.nome}
            </CardDescription>
          )}
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            <div>
              <Label className="font-bold text-gray-700">Nome do Item</Label>
              <Input
                placeholder="Nome do item"
                value={nome}
                onChange={(e) => setNome(e.target.value)}
                className="rounded-full border-2 border-gray-300 h-12"
              />
            </div>
            <div>
              <Label className="font-bold text-gray-700">Descri√ß√£o</Label>
              <Input
                placeholder="Descri√ß√£o do item"
                value={descricao}
                onChange={(e) => setDescricao(e.target.value)}
                className="rounded-full border-2 border-gray-300 h-12"
              />
            </div>
            <div>
              <Label className="font-bold text-gray-700">Imagem do Item (opcional)</Label>
              <div className="space-y-3">
                <Input
                  type="file"
                  accept="image/*"
                  onChange={handleImagemChange}
                  className="rounded-full border-2 border-gray-300 h-12 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                />
                {imagemPreview && (
                  <div className="relative">
                    <img 
                      src={imagemPreview} 
                      alt="Preview" 
                      className="w-32 h-32 object-cover rounded-xl border-2 border-gray-200" 
                    />
                    <button
                      type="button"
                      onClick={limparImagem}
                      className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600"
                    >
                      √ó
                    </button>
                  </div>
                )}
              </div>
            </div>
            <div>
              <Label className="font-bold text-gray-700">Pre√ßo (moedas)</Label>
              <Input
                type="number"
                placeholder="0"
                value={preco}
                onChange={(e) => setPreco(e.target.value)}
                className="rounded-full border-2 border-gray-300 h-12"
              />
            </div>
            <div>
              <Label className="font-bold text-gray-700">Quantidade Dispon√≠vel</Label>
              <Input
                type="number"
                placeholder="0"
                value={quantidade}
                onChange={(e) => setQuantidade(e.target.value)}
                className="rounded-full border-2 border-gray-300 h-12"
                min="0"
              />
            </div>
            <div>
              <Label className="font-bold text-gray-700">Rodada</Label>
              <Select value={rodadaSelecionada} onValueChange={setRodadaSelecionada}>
                <SelectTrigger className="h-12 rounded-full border-2 border-gray-300">
                  <SelectValue placeholder="Selecione a rodada" />
                </SelectTrigger>
                <SelectContent>
                  {torneio.rodadas.map((rodada: any) => (
                    <SelectItem key={rodada.id} value={rodada.id}>
                      {rodada.nome}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            <div className="flex gap-3">
              {modoEdicao ? (
                <>
                  <Button 
                    onClick={handleSalvarEdicao} 
                    disabled={uploadandoImagem}
                    className="flex-1 h-12 rounded-full font-bold bg-gradient-to-r from-green-400 to-emerald-400 hover:from-green-500 hover:to-emerald-500 text-white disabled:opacity-50"
                  >
                    {uploadandoImagem ? "ENVIANDO IMAGEM..." : "SALVAR ALTERA√á√ïES"}
                  </Button>
                  <Button onClick={handleCancelarEdicao} variant="outline" className="flex-1 h-12 rounded-full font-bold border-2 border-gray-300 text-gray-600 hover:bg-gray-50">
                    CANCELAR
                  </Button>
                </>
              ) : (
                <Button 
                  onClick={handleAdicionarItem} 
                  disabled={uploadandoImagem}
                  className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-blue-400 to-purple-400 hover:from-blue-500 hover:to-purple-500 text-white disabled:opacity-50"
                >
                  {uploadandoImagem ? "ENVIANDO IMAGEM..." : "ADICIONAR ITEM"}
                </Button>
              )}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Itens Dispon√≠veis */}
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-orange-400 to-yellow-400 text-white px-6 py-6">
          <CardTitle className="text-2xl font-black">Itens Dispon√≠veis</CardTitle>
          <CardDescription className="text-orange-100 font-semibold">
            {torneio.itensLoja.length} {torneio.itensLoja.length === 1 ? 'item' : 'itens'} na loja
          </CardDescription>
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            {torneio.itensLoja.length === 0 ? (
              <div className="text-center py-8">
                <ShoppingBag className="w-12 h-12 mx-auto mb-2 text-gray-300" />
                <p className="text-gray-500 font-semibold">Nenhum item cadastrado</p>
                <p className="text-sm text-gray-400">Adicione o primeiro item √† loja!</p>
              </div>
            ) : (
              torneio.itensLoja.map((item: any) => (
                <div key={item.id} className="p-4 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-xl border-2 border-orange-200 hover:shadow-lg transition-all">
                  <div className="flex justify-between items-start gap-4">
                    {item.imagem && (
                      <div className="flex-shrink-0">
                        <img 
                          src={item.imagem} 
                          alt={item.nome}
                          className="w-16 h-16 object-cover rounded-lg border-2 border-orange-200" 
                        />
                      </div>
                    )}
                    <div className="flex-1">
                      <h3 className="font-black text-lg text-gray-800 mb-1">{item.nome}</h3>
                      <p className="text-sm text-gray-600 font-semibold mb-2">{item.descricao}</p>
                      <div className="flex items-center gap-4">
                        <p className="text-lg font-black text-orange-600">{item.preco} moedas</p>
                        <span className="text-xs bg-orange-200 text-orange-800 px-2 py-1 rounded-full font-semibold">
                          {torneio.rodadas.find((r: any) => r.id === item.rodada)?.nome || 'Rodada n√£o encontrada'}
                        </span>
                        <span className="text-xs bg-green-200 text-green-800 px-2 py-1 rounded-full font-semibold">
                          {item.quantidadeDisponivel || 0}/{item.quantidadeTotal || 0} dispon√≠vel
                        </span>
                      </div>
                    </div>
                    <div className="flex gap-2 ml-4">
                      <Button
                        onClick={() => handleEditarItem(item)}
                        variant="outline"
                        size="sm"
                        className="rounded-full border-2 border-blue-300 text-blue-600 hover:bg-blue-50"
                        disabled={modoEdicao}
                      >
                        <Edit className="w-4 h-4" />
                      </Button>
                      <Button
                        onClick={() => handleRemoverItem(item.id)}
                        variant="outline"
                        size="sm"
                        className="rounded-full border-2 border-red-300 text-red-600 hover:bg-red-50"
                        disabled={modoEdicao}
                      >
                        <Trash2 className="w-4 h-4" />
                      </Button>
                    </div>
                  </div>
                </div>
              ))
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

// Componente da tabela de ranking
function RankingTable({
  title,
  data,
  showRoundPoints = false,
  showBonusPoints = false
}: {
  title: string;
  data: (Dupla & {
    pontosRodada?: number;
    moedasRodada?: number;
    medalhasRodada?: number;
    pontosBonus?: number;
    moedasBonus?: number;
    medalhasBonus?: number;
  })[];
  showRoundPoints?: boolean;
  showBonusPoints?: boolean;
}) {
  // Debug: Ver os dados que est√£o chegando
  console.log(`üîç RankingTable Debug - ${title}:`, {
    dataLength: data.length,
    showRoundPoints,
    showBonusPoints,
    sampleData: data.slice(0, 3).map(d => ({
      tag: d.tag,
      pontos: d.pontos,
      pontosRodada: d.pontosRodada,
      pontosBonus: d.pontosBonus,
      pontosPorRodada: d.pontosPorRodada,
      pontosPorBonus: d.pontosPorBonus
    }))
  });

  // Verificar se h√° dados relevantes
  const hasRelevantData = data.some(dupla => {
    if (showRoundPoints) {
      return (dupla.pontosRodada || 0) > 0 || (dupla.moedasRodada || 0) > 0 || (dupla.medalhasRodada || 0) > 0;
    } else if (showBonusPoints) {
      return (dupla.pontosBonus || 0) > 0 || (dupla.moedasBonus || 0) > 0 || (dupla.medalhasBonus || 0) > 0;
    }
    return true; // Para ranking geral, sempre mostrar
  });
  return (
    <div className="ranking-card table-container-responsive bg-white rounded-2xl sm:rounded-3xl shadow-xl overflow-hidden border-0 max-w-full">
      {title && (
        <div className="p-4 sm:p-6 bg-gradient-to-r bg-[#AEE1F9]">
          <h2 className="text-xl sm:text-2xl lg:text-3xl font-black text-white text-center drop-shadow-lg">{title}</h2>
        </div>
      )}
      <div className="p-3 sm:p-4 lg:p-6 max-w-full overflow-hidden">
        {/* Container com scroll horizontal para mobile e desktop compacto */}
        <div className="overflow-x-auto custom-scrollbar mobile-scroll-container">
          <div className="min-w-full space-y-3 sm:space-y-4">
            {data.length === 0 ? (
              <div className="text-center py-12">
                <Trophy className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                <h3 className="text-lg font-bold text-gray-600 mb-2">Nenhuma dupla encontrada</h3>
                <p className="text-gray-500">Crie duplas primeiro para visualizar o ranking</p>
              </div>
            ) : !hasRelevantData && (showRoundPoints || showBonusPoints) ? (
              <div className="text-center py-12">
                <Trophy className="w-16 h-16 mx-auto text-gray-300 mb-4" />
                <h3 className="text-lg font-bold text-gray-600 mb-2">
                  {showRoundPoints ? "Nenhuma pontua√ß√£o registrada para esta rodada" : "Nenhuma pontua√ß√£o registrada para este b√¥nus"}
                </h3>
                <p className="text-gray-500">
                  {showRoundPoints
                    ? "Adicione pontua√ß√µes nas duplas atrav√©s da aba 'Duplas' para ver o ranking desta rodada"
                    : "Adicione pontua√ß√µes de b√¥nus atrav√©s da aba 'B√¥nus' para ver este ranking"}
                </p>
              </div>
            ) : (
              data.map((dupla, index) => {
                // Determinar quais valores exibir baseado no tipo de tabela
                let pontosParaExibir, moedasParaExibir, medalhasParaExibir;

                if (showBonusPoints) {
                  // Para tabelas de b√¥nus, mostrar apenas os valores do b√¥nus
                  pontosParaExibir = Number(dupla.pontosBonus) || 0;
                  moedasParaExibir = Number(dupla.moedasBonus) || 0;
                  medalhasParaExibir = Number(dupla.medalhasBonus) || 0;
                  console.log('DEBUG BONUS:', dupla.tag, { pontosBonus: dupla.pontosBonus, pontosParaExibir });
                } else if (showRoundPoints) {
                  // Para tabelas de rodada, mostrar apenas valores da rodada
                  pontosParaExibir = Number(dupla.pontosRodada) || 0;
                  moedasParaExibir = Number(dupla.moedasRodada) || 0;
                  medalhasParaExibir = Number(dupla.medalhasRodada) || 0;
                  console.log('DEBUG RODADA:', dupla.tag, { pontosRodada: dupla.pontosRodada, pontosParaExibir });
                } else {
                  // Para ranking geral, mostrar totais
                  pontosParaExibir = Number(dupla.pontos) || 0;
                  moedasParaExibir = Number(dupla.moedas) || 0;
                  medalhasParaExibir = Number(dupla.medalhas) || 0;
                  console.log('DEBUG GERAL:', dupla.tag, { pontos: dupla.pontos, pontosParaExibir });
                }

                // Garantir que todos os valores s√£o n√∫meros v√°lidos
                pontosParaExibir = isNaN(pontosParaExibir) ? 0 : pontosParaExibir;
                moedasParaExibir = isNaN(moedasParaExibir) ? 0 : moedasParaExibir;
                medalhasParaExibir = isNaN(medalhasParaExibir) ? 0 : medalhasParaExibir; return (
                  <div
                    key={dupla.id}
                    className="ranking-card flex items-center gap-3 sm:gap-4 lg:gap-6 p-3 sm:p-4 lg:p-5 rounded-xl sm:rounded-2xl border-2 border-transparent min-w-max mobile-scroll-item desktop-compact shadow-sm hover:shadow-md transition-all duration-300"
                    style={{ '--hover-border-color': '#AEE1F9' } as React.CSSProperties}
                    onMouseEnter={(e) => e.currentTarget.style.borderColor = '#AEE1F9'}
                    onMouseLeave={(e) => e.currentTarget.style.borderColor = 'transparent'}
                  >
                    {/* Posi√ß√£o - com gradiente da classe CSS */}
                    <div className="ranking-position w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-xl sm:rounded-2xl flex items-center justify-center font-black text-white text-sm sm:text-lg lg:text-xl flex-shrink-0">
                      {(dupla as any).posicao || (index + 1)}¬∞
                    </div>

                    {/* Nome da Dupla - com banner quando dispon√≠vel */}
                    <div className="ranking-name-container rounded-xl sm:rounded-2xl overflow-hidden min-w-0 w-24 sm:flex-1">
                      <div className="relative w-full h-12 sm:h-16 lg:h-20">
                        <BannerDupla 
                          dupla={dupla} 
                          className="w-full h-full rounded-xl sm:rounded-2xl text-xs sm:text-base"
                        />
                      </div>
                    </div>

                    {/* Estat√≠sticas - com classes CSS customizadas */}
                    <div className="flex gap-2 sm:gap-3 lg:gap-4 flex-shrink-0">
                      {/* Medalhas */}
                      <div className="medals-badge stat-badge w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-xl sm:rounded-2xl flex flex-col items-center justify-center text-white flex-shrink-0 touch-target">
                        <Medal className="w-3 h-3 sm:w-4 sm:h-4 lg:w-5 lg:h-5 mb-0.5" />
                        <span className="font-black text-xs sm:text-sm lg:text-base">{pontosParaExibir}</span>
                      </div>

                      {/* Pontos */}
                      <div className="stars-badge stat-badge w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-xl sm:rounded-2xl flex flex-col items-center justify-center text-white flex-shrink-0 touch-target">
                        <Star className="w-3 h-3 sm:w-4 sm:h-4 lg:w-5 lg:h-5 mb-0.5" />
                        <span className="font-black text-xs sm:text-sm lg:text-base">{medalhasParaExibir}</span>
                      </div>

                      {/* Moedas */}
                      <div className="coins-badge stat-badge w-12 h-12 sm:w-14 sm:h-14 lg:w-16 lg:h-16 rounded-xl sm:rounded-2xl flex flex-col items-center justify-center text-white flex-shrink-0 touch-target">
                        <Coins className="w-3 h-3 sm:w-4 sm:h-4 lg:w-5 lg:h-5 mb-0.5" />
                        <span className="font-black text-xs sm:text-sm lg:text-base">{moedasParaExibir}</span>
                      </div>
                    </div>
                  </div>
                );
              })
            )}
          </div>
        </div>
      </div>
    </div>
  )
}

// Componente da loja para alunos
function LojaView({ torneio, showComprarButton = true }: { torneio: any; showComprarButton?: boolean }) {
  const jambaVIP = torneio.getDuplasPorCategoria('JambaVIP')
  const jamberlinda = torneio.getDuplasPorCategoria('Jamberlinda')
  const aguardando = torneio.getDuplasAguardando()

  return (
    <div className="space-y-3 sm:space-y-4 lg:space-y-6 max-w-6xl mx-auto relative">

      {/* Mascote da Lojinha - Fora do card para n√£o ser cortado */}
      <div className="absolute -top-2 -right-2 sm:-top-4 sm:-right-4 w-20 h-20 sm:w-32 sm:h-32 z-50">
        <img
          src="/shop_crazy.png"
          alt="Mascote da Lojinha"
          className="w-full h-full object-contain animate-bounce"
          style={{ filter: "drop-shadow(2px 2px 4px rgba(0,0,0,0.3))" }}
        />
      </div>

      {/* Bal√£o de fala do mascote */}
      <div className="absolute top-2 right-16 sm:right-28 bg-white rounded-2xl p-2 sm:p-3 shadow-lg border-2 border-yellow-300 z-30 hidden sm:block">
        <div className="text-xs sm:text-sm font-bold text-gray-800 whitespace-nowrap">
          üé™ Bem-vindos √† minha loja!
        </div>
        <div className="absolute -bottom-2 right-4 w-0 h-0 border-l-8 border-r-8 border-t-8 border-l-transparent border-r-transparent border-t-white"></div>
      </div>

      {/* Loja Misteriosa */}
      <Card className="border-0 shadow-lg sm:shadow-xl lg:shadow-2xl bg-white rounded-xl sm:rounded-2xl lg:rounded-3xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-slate-600 to-slate-800 text-white px-3 sm:px-4 lg:px-6 py-3 sm:py-4 lg:py-6 relative">
          <CardTitle className="flex items-center space-x-2 sm:space-x-3 text-base sm:text-lg lg:text-2xl font-black">
            <ShoppingBag className="w-4 h-4 sm:w-5 sm:h-5 lg:w-6 lg:h-6 flex-shrink-0" />
            <span>Lojinha Misteriosa</span>
          </CardTitle>
          <CardDescription className="text-slate-200 font-semibold text-xs sm:text-sm lg:text-base">
            {showComprarButton ? 'Use suas moedas para comprar itens especiais' : 'Veja os itens especiais dispon√≠veis'}
          </CardDescription>
        </CardHeader>
        <CardContent className="p-2 sm:p-3 lg:p-6">
          {/* Container com scroll horizontal otimizado */}
          <div className="overflow-x-auto custom-scrollbar hover-scale-container">
            <div className="flex gap-3 sm:gap-4 lg:grid lg:grid-cols-2 xl:grid-cols-3 lg:gap-4 xl:gap-6 min-w-full scroll-smooth-x p-1 sm:p-2">
              {torneio.itensLoja.map((item: any, index: number) => (
                <div
                  key={index}
                  className="flex-shrink-0 w-64 sm:w-72 lg:w-auto p-3 sm:p-4 lg:p-6 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-lg sm:rounded-xl lg:rounded-2xl border-2 border-orange-200 hover:shadow-lg transition-all duration-200 transform hover:scale-105 hover-scale-item"
                >
                  <div className="flex gap-3 sm:gap-4">
                    {/* Imagem do Item */}
                    <div className="flex-shrink-0 w-16 h-16 sm:w-20 sm:h-20 lg:w-24 lg:h-24 rounded-lg overflow-hidden bg-orange-200 flex items-center justify-center">
                      {item.imagem ? (
                        <img
                          src={item.imagem}
                          alt={item.nome}
                          className="w-full h-full object-cover"
                          onError={(e) => {
                            e.currentTarget.style.display = 'none';
                            const fallback = e.currentTarget.nextElementSibling as HTMLElement;
                            if (fallback) fallback.style.display = 'flex';
                          }}
                        />
                      ) : null}
                      <div className={`w-full h-full flex items-center justify-center ${item.imagem ? 'hidden' : 'flex'}`}>
                        <span className="text-orange-400 text-xl sm:text-2xl lg:text-3xl font-bold">
                          {item.nome?.charAt(0)?.toUpperCase() || '?'}
                        </span>
                      </div>
                    </div>
                    
                    {/* Conte√∫do do Item */}
                    <div className="flex-1 min-w-0">
                      <h3 className="font-black text-sm sm:text-base lg:text-xl text-gray-800 mb-2 line-clamp-1">{item.nome}</h3>
                      <p className="text-gray-600 text-xs sm:text-sm mb-2 font-semibold line-clamp-2 lg:line-clamp-3">{item.descricao}</p>
                      
                      {/* Quantidade Dispon√≠vel */}
                      <div className="mb-2 sm:mb-3 lg:mb-4">
                        <span className={`text-xs sm:text-sm font-bold px-2 py-1 rounded-full ${
                          item.quantidadeDisponivel <= 0 
                            ? 'bg-red-100 text-red-600' 
                            : item.quantidadeDisponivel <= 5 
                              ? 'bg-yellow-100 text-yellow-600' 
                              : 'bg-green-100 text-green-600'
                        }`}>
                          {item.quantidadeDisponivel <= 0 
                            ? 'Esgotado' 
                            : `${item.quantidadeDisponivel} ${item.quantidadeDisponivel === 1 ? 'dispon√≠vel' : 'dispon√≠veis'}`
                          }
                        </span>
                      </div>
                      
                      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 sm:gap-0">
                        <span className="text-base sm:text-lg lg:text-2xl font-black text-orange-600">{item.preco} moedas</span>
                        {showComprarButton && (
                          <Button 
                            className="w-full sm:w-auto rounded-full bg-gradient-to-r from-green-400 to-emerald-400 hover:from-green-500 hover:to-emerald-500 text-white font-bold px-3 sm:px-4 lg:px-6 py-1 sm:py-2 text-xs sm:text-sm lg:text-base touch-target disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled={item.quantidadeDisponivel <= 0}
                          >
                            {item.quantidadeDisponivel <= 0 ? 'Esgotado' : 'Comprar'}
                          </Button>
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Categorias Especiais */}
      <div className="space-y-3 sm:space-y-4 lg:space-y-0 lg:grid lg:grid-cols-2 lg:gap-4 xl:gap-6">
        {/* JambaVIP */}
        <Card className="border-0 shadow-lg sm:shadow-xl lg:shadow-2xl bg-white rounded-xl sm:rounded-2xl lg:rounded-3xl overflow-hidden">
          <CardHeader className="text-white px-3 sm:px-4 lg:px-6 py-2 sm:py-3 lg:py-4" style={{ backgroundColor: "#AEE1F9" }}>
            <CardTitle className="text-sm sm:text-base lg:text-xl font-black">JambaVIP</CardTitle>
          </CardHeader>
          <CardContent className="p-2 sm:p-3 lg:p-6">
            <div className="space-y-2 sm:space-y-3 lg:space-y-4 max-h-48 sm:max-h-56 lg:max-h-80 overflow-y-auto">
              {jambaVIP.length === 0 ? (
                <div className="text-center py-8">
                  <Crown className="w-12 h-12 mx-auto text-purple-300 mb-2" />
                  <p className="text-purple-600 font-bold text-sm">Categoria vazia</p>
                </div>
              ) : (
                jambaVIP.slice(0, 2).map((dupla: Dupla) => (
                  <div key={dupla.id} className="p-4 rounded-2xl border-2" style={{ backgroundColor: "#F0F8FF", borderColor: "#AEE1F9" }}>
                    <div className="mb-2">
                      <BannerDupla 
                        dupla={dupla} 
                        className="w-full h-12 rounded-lg text-sm"
                      />
                    </div>
                    <p className="text-sm text-gray-600 font-semibold">{dupla.pontos} pontos ‚Ä¢ {dupla.moedas} moedas</p>
                  </div>
                ))
              )}
            </div>
          </CardContent>
        </Card>

        {/* Jamberlinda */}
        <Card className="border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
          <CardHeader className="text-white px-6 py-4" style={{ backgroundColor: "#AEE1F9" }}>
            <CardTitle className="text-xl font-black">Jamberlinda</CardTitle>
          </CardHeader>
          <CardContent className="p-6">
            <div className="space-y-4">
              {jamberlinda.length === 0 ? (
                <div className="text-center py-8">
                  <Crown className="w-12 h-12 mx-auto mb-2" style={{ color: "#AEE1F9" }} />
                  <p className="font-bold text-sm" style={{ color: "#AEE1F9" }}>Categoria vazia</p>
                </div>
              ) : (
                jamberlinda.slice(0, 2).map((dupla: Dupla) => (
                  <div key={dupla.id} className="p-4 rounded-2xl border-2" style={{ backgroundColor: "#F0F8FF", borderColor: "#AEE1F9" }}>
                    <div className="mb-2">
                      <BannerDupla 
                        dupla={dupla} 
                        className="w-full h-12 rounded-lg text-sm"
                      />
                    </div>
                    <p className="text-sm text-gray-600 font-semibold">{dupla.pontos} pontos ‚Ä¢ {dupla.moedas} moedas</p>
                  </div>
                ))
              )}
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Duplas Aguardando */}
      <Card className="border-0 shadow-2xl bg-white rounded-3xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-yellow-400 to-orange-400 text-white px-6 py-4">
          <CardTitle className="text-xl font-black">Duplas Aguardando Resultado</CardTitle>
        </CardHeader>
        <CardContent className="p-3 sm:p-6">
          <div className="overflow-x-auto">
            <div className="flex flex-col sm:grid sm:grid-cols-1 md:grid-cols-3 gap-4 min-w-full">
              {aguardando.length === 0 ? (
                <div className="col-span-full text-center py-8">
                  <div className="w-12 h-12 mx-auto bg-yellow-300 rounded-full flex items-center justify-center mb-2">
                    <span className="text-yellow-800 font-bold">!</span>
                  </div>
                  <p className="text-yellow-600 font-bold text-sm">Nenhuma dupla aguardando resultado</p>
                </div>
              ) : (
                aguardando.map((dupla: Dupla) => (
                  <div key={dupla.id} className="flex-shrink-0 p-4 bg-gradient-to-r from-yellow-100 to-orange-100 rounded-2xl text-center border-2 border-yellow-200 min-w-48">
                    <div className="mb-2">
                      <BannerDupla 
                        dupla={dupla} 
                        className="w-full h-12 rounded-lg text-sm mx-auto"
                      />
                    </div>
                    <p className="text-sm text-gray-600 font-semibold">Aguardando...</p>
                  </div>
                ))
              )}
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

// Componente para gerenciar rodadas
function GerenciamentoRodadas({ torneio }: { torneio: any }) {
  const [nome, setNome] = useState("")
  const [descricao, setDescricao] = useState("")
  const [pontuacaoMaxima, setPontuacaoMaxima] = useState("")
  const [numero, setNumero] = useState("")
  const [rodadaParaExcluir, setRodadaParaExcluir] = useState<string | null>(null)

  const handleCriarRodada = async () => {
    try {
      if (!nome || !descricao || !pontuacaoMaxima || !numero) {
        toast.error("Preencha todos os campos!")
        return
      }

      await torneio.criarRodada(nome, parseInt(numero), descricao, parseInt(pontuacaoMaxima))
      toast.success("Rodada criada com sucesso!")
      setNome("")
      setDescricao("")
      setPontuacaoMaxima("")
      setNumero("")
    } catch (error) {
      toast.error("Erro ao criar rodada")
    }
  }

  const handleExcluirRodada = async (rodadaId: string) => {
    try {
      const rodada = torneio.rodadas.find((r: any) => r.id === rodadaId)
      await torneio.excluirRodada(rodadaId)
      setRodadaParaExcluir(null)
      toast.success(`Rodada "${rodada?.nome}" exclu√≠da com sucesso!`)
    } catch (error) {
      console.error('Erro ao excluir rodada:', error)
      toast.error("Erro ao excluir rodada!")
    }
  }

  return (
    <div className="space-y-6">
      {/* Criar Nova Rodada */}
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-6 py-6">
          <CardTitle className="text-2xl font-black flex items-center space-x-2">
            <Calendar className="w-6 h-6" />
            <span>Criar Nova Rodada</span>
          </CardTitle>
          <CardDescription className="text-indigo-100 font-semibold">
            Configure uma nova etapa do torneio
          </CardDescription>
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label className="font-bold text-gray-700">Nome da Rodada</Label>
                <Input
                  placeholder="Nome da rodada"
                  value={nome}
                  onChange={(e) => setNome(e.target.value)}
                  className="rounded-full border-2 border-gray-300 h-12"
                />
              </div>
              <div>
                <Label className="font-bold text-gray-700">N√∫mero da Rodada</Label>
                <Input
                  type="number"
                  placeholder="4"
                  value={numero}
                  onChange={(e) => setNumero(e.target.value)}
                  className="rounded-full border-2 border-gray-300 h-12"
                />
              </div>
            </div>

            <div>
              <Label className="font-bold text-gray-700">Descri√ß√£o</Label>
              <Textarea
                placeholder="Descri√ß√£o da rodada"
                value={descricao}
                onChange={(e) => setDescricao(e.target.value)}
                className="rounded-xl border-2 border-gray-300 min-h-[80px] resize-none"
                rows={3}
              />
            </div>

            <div>
              <Label className="font-bold text-gray-700">Pontua√ß√£o M√°xima</Label>
              <Input
                type="number"
                placeholder="500"
                value={pontuacaoMaxima}
                onChange={(e) => setPontuacaoMaxima(e.target.value)}
                className="rounded-full border-2 border-gray-300 h-12"
              />
            </div>

            <Button
              onClick={handleCriarRodada}
              className="w-full h-12 rounded-full font-bold bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-indigo-600 hover:to-purple-600 text-white"
            >
              CRIAR RODADA
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* Lista de Rodadas Existentes */}
      <Card className="border-0 shadow-2xl bg-white rounded-2xl overflow-hidden">
        <CardHeader className="bg-gradient-to-r from-blue-500 to-cyan-500 text-white px-6 py-6">
          <CardTitle className="text-2xl font-black">Rodadas do Torneio</CardTitle>
          <CardDescription className="text-blue-100 font-semibold">
            Gerencie todas as etapas do torneio
          </CardDescription>
        </CardHeader>
        <CardContent className="p-6">
          <div className="space-y-4">
            {torneio.rodadas.length === 0 ? (
              <div className="text-center py-8">
                <Calendar className="w-16 h-16 text-gray-400 mx-auto mb-4" />
                <p className="text-gray-500 font-semibold">Nenhuma rodada criada ainda</p>
                <p className="text-sm text-gray-400">Crie a primeira rodada para come√ßar!</p>
                <p className="text-sm text-gray-400">Crie a primeira rodada usando o formul√°rio acima</p>
              </div>
            ) : (
              torneio.rodadas.map((rodada: any, index: number) => (
                <div
                  key={rodada.id}
                  className="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 flex justify-between items-start"
                >
                  <div className="flex-1">
                    <div className="flex items-center space-x-3 mb-2">
                      <h3 className="font-black text-xl text-gray-800">{rodada.nome}</h3>
                      <div className={`px-3 py-1 rounded-full text-xs font-bold ${rodada.ativa
                        ? 'bg-green-100 text-green-800'
                        : rodada.finalizada
                          ? 'bg-gray-100 text-gray-800'
                          : 'bg-yellow-100 text-yellow-800'
                        }`}>
                        {rodada.ativa ? 'ATIVA' : rodada.finalizada ? 'FINALIZADA' : 'PENDENTE'}
                      </div>
                    </div>
                    <p className="text-gray-600 font-semibold mb-3">{rodada.descricao}</p>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                      <div className="flex items-center space-x-2">
                        <Target className="w-4 h-4 text-indigo-500" />
                        <span className="font-semibold text-gray-700">
                          Pontua√ß√£o M√°xima: {rodada.pontuacaoMaxima}
                        </span>
                      </div>
                      <div className="flex items-center space-x-2">
                        <Calendar className="w-4 h-4 text-indigo-500" />
                        <span className="font-semibold text-gray-700">
                          Rodada #{rodada.numero}
                        </span>
                      </div>
                      {rodada.dataInicio && (
                        <div className="flex items-center space-x-2">
                          <Star className="w-4 h-4 text-indigo-500" />
                          <span className="font-semibold text-gray-700">
                            Criada em: {new Date(rodada.dataInicio.seconds * 1000).toLocaleDateString()}
                          </span>
                        </div>
                      )}
                    </div>
                  </div>
                  <div className="flex flex-col space-y-2 ml-4">
                    {!rodada.ativa && !rodada.finalizada && (
                      <Button
                        onClick={() => torneio.ativarRodada(rodada.id)}
                        size="sm"
                        className="rounded-full bg-green-500 hover:bg-green-600 text-white font-bold"
                      >
                        Ativar
                      </Button>
                    )}
                    {rodada.ativa && (
                      <Button
                        size="sm"
                        className="rounded-full bg-blue-500 hover:bg-blue-600 text-white font-bold"
                        disabled
                      >
                        Ativa
                      </Button>
                    )}
                    <Button
                      onClick={() => setRodadaParaExcluir(rodada.id)}
                      size="sm"
                      variant="destructive"
                      className="rounded-full bg-red-500 hover:bg-red-600 text-white font-bold"
                    >
                      <Trash2 className="w-4 h-4" />
                    </Button>
                  </div>
                </div>
              ))
            )}
          </div>
        </CardContent>
      </Card>

      {/* Dialog de confirma√ß√£o para exclus√£o */}
      <AlertDialog open={!!rodadaParaExcluir} onOpenChange={() => setRodadaParaExcluir(null)}>
        <AlertDialogContent>
          <AlertDialogHeader>
            <AlertDialogTitle>Confirmar Exclus√£o</AlertDialogTitle>
            <AlertDialogDescription>
              {(() => {
                const rodada = torneio.rodadas.find((r: any) => r.id === rodadaParaExcluir);
                if (rodada?.ativa) {
                  return "ATEN√á√ÉO: Voc√™ est√° prestes a excluir a rodada ATIVA! Esta a√ß√£o remover√° a rodada atual do torneio e todos os dados associados ser√£o perdidos permanentemente. Tem certeza?";
                }
                return "Tem certeza que deseja excluir esta rodada? Esta a√ß√£o n√£o pode ser desfeita e todos os dados associados ser√£o perdidos permanentemente.";
              })()}
            </AlertDialogDescription>
          </AlertDialogHeader>
          <AlertDialogFooter>
            <AlertDialogCancel>Cancelar</AlertDialogCancel>
            <AlertDialogAction
              onClick={() => rodadaParaExcluir && handleExcluirRodada(rodadaParaExcluir)}
              className="bg-red-500 hover:bg-red-600"
            >
              Excluir Rodada
            </AlertDialogAction>
          </AlertDialogFooter>
        </AlertDialogContent>
      </AlertDialog>
    </div>
  )
}